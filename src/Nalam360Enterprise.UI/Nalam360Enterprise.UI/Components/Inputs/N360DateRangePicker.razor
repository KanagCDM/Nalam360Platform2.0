@using Syncfusion.Blazor.Calendars
@using Nalam360Enterprise.UI.Core.Security
@using Nalam360Enterprise.UI.Core.Forms

@inject IPermissionService? PermissionService
@inject IAuditService? AuditService

@if (!HideIfNoPermission || _hasPermission)
{
    <div class="n360-daterangepicker @CssClass" dir="@(IsRtl ? "rtl" : "ltr")">
        @if (!string.IsNullOrEmpty(Label))
        {
            <label class="n360-daterangepicker__label">
                @Label
                @if (IsRequired)
                {
                    <span class="n360-daterangepicker__required" aria-label="required">*</span>
                }
            </label>
        }

        <SfDateRangePicker TValue="DateTime?"
                           @bind-StartDate="@StartDate"
                           @bind-EndDate="@EndDate"
                           Placeholder="@Placeholder"
                           Enabled="@(!Disabled && _hasPermission)"
                           ReadOnly="@ReadOnly"
                           ShowClearButton="@ShowClearButton"
                           Format="@Format"
                           MinDays="@MinDays"
                           MaxDays="@MaxDays"
                           Min="@(Min ?? default(DateTime))"
                           Max="@(Max ?? default(DateTime))"
                           StrictMode="@StrictMode"
                           FirstDayOfWeek="@FirstDayOfWeek"
                           CssClass="@GetInternalCssClass()"
                           RangeSelected="@OnRangeSelectedHandler">
            @if (Presets != null && Presets.Any())
            {
                <DateRangePickerPresets>
                    @foreach (var preset in Presets)
                    {
                        <DateRangePickerPreset Label="@preset.Label" 
                                               Start="@preset.Start" 
                                               End="@preset.End" />
                    }
                </DateRangePickerPresets>
            }
        </SfDateRangePicker>

        @if (!string.IsNullOrEmpty(HelpText))
        {
            <small class="n360-daterangepicker__help-text">@HelpText</small>
        }

        @if (ValidationErrors?.Any() == true)
        {
            <div class="n360-daterangepicker__validation">
                @foreach (var error in ValidationErrors)
                {
                    <span class="n360-daterangepicker__error">@error</span>
                }
            </div>
        }
    </div>
}

@code {
    [Parameter] public DateTime? StartDate { get; set; }
    [Parameter] public EventCallback<DateTime?> StartDateChanged { get; set; }
    [Parameter] public DateTime? EndDate { get; set; }
    [Parameter] public EventCallback<DateTime?> EndDateChanged { get; set; }
    [Parameter] public string? Placeholder { get; set; }
    [Parameter] public string? Label { get; set; }
    [Parameter] public bool IsRequired { get; set; }
    [Parameter] public string? HelpText { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public bool ReadOnly { get; set; }
    [Parameter] public bool ShowClearButton { get; set; } = true;
    [Parameter] public string Format { get; set; } = "MM/dd/yyyy";
    [Parameter] public int? MinDays { get; set; }
    [Parameter] public int? MaxDays { get; set; }
    [Parameter] public DateTime? Min { get; set; }
    [Parameter] public DateTime? Max { get; set; }
    [Parameter] public bool StrictMode { get; set; }
    [Parameter] public int FirstDayOfWeek { get; set; } = 0; // Sunday
    [Parameter] public IEnumerable<DateRangePreset>? Presets { get; set; }

    // Styling
    [Parameter] public string? CssClass { get; set; }
    [Parameter] public string? InternalCssClass { get; set; }
    [Parameter] public bool IsRtl { get; set; }

    // RBAC
    [Parameter] public string? RequiredPermission { get; set; }
    [Parameter] public bool HideIfNoPermission { get; set; }

    // Audit
    [Parameter] public bool EnableAudit { get; set; }
    [Parameter] public string? AuditResource { get; set; }
    [Parameter] public string? AuditAction { get; set; }

    // Validation
    [Parameter] public List<IValidationRule<DateTime[]>>? ValidationRules { get; set; }
    [Parameter] public List<string>? ValidationErrors { get; set; }

    // Events
    [Parameter] public EventCallback<DateRangeEventArgs> OnRangeSelected { get; set; }

    private bool _hasPermission = true;
    private DateTime? _previousStartDate;
    private DateTime? _previousEndDate;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(RequiredPermission) && PermissionService != null)
        {
            _hasPermission = await PermissionService.HasPermissionAsync(RequiredPermission);
        }

        _previousStartDate = StartDate;
        _previousEndDate = EndDate;
    }

    private async Task OnRangeSelectedHandler(RangePickerEventArgs<DateTime?> args)
    {
        var oldStartDate = _previousStartDate;
        var oldEndDate = _previousEndDate;
        var newStartDate = args.StartDate;
        var newEndDate = args.EndDate;

        // Validation
        if (ValidationRules?.Any() == true)
        {
            ValidationErrors = new List<string>();
            var dateArray = new DateTime[] { newStartDate ?? DateTime.MinValue, newEndDate ?? DateTime.MinValue };
            foreach (var rule in ValidationRules)
            {
                var result = await rule.ValidateAsync(dateArray);
                if (!result.IsValid)
                {
                    ValidationErrors.AddRange(result.Errors.Select(e => e.Message));
                    return;
                }
            }
        }

        // Audit
        if (EnableAudit && AuditService != null)
        {
            await AuditService.LogAsync(new AuditMetadata
            {
                Resource = AuditResource ?? "DateRangePicker",
                Action = AuditAction ?? "RangeChanged",
                Timestamp = DateTime.UtcNow,
                AdditionalData = new Dictionary<string, object>
                {
                    ["OldValue"] = $"{oldStartDate?.ToString(Format)} - {oldEndDate?.ToString(Format)}",
                    ["NewValue"] = $"{newStartDate?.ToString(Format)} - {newEndDate?.ToString(Format)}"
                }
            });
        }

        _previousStartDate = newStartDate;
        _previousEndDate = newEndDate;

        // Trigger change event
        await OnRangeSelected.InvokeAsync(new DateRangeEventArgs 
        { 
            StartDate = newStartDate, 
            EndDate = newEndDate 
        });
    }

    private string GetInternalCssClass()
    {
        var classes = new List<string> { "n360-daterangepicker__control" };
        
        if (!string.IsNullOrEmpty(InternalCssClass))
        {
            classes.Add(InternalCssClass);
        }

        if (ValidationErrors?.Any() == true)
        {
            classes.Add("n360-daterangepicker__control--error");
        }

        return string.Join(" ", classes);
    }

    private Dictionary<string, object> GetHtmlAttributes()
    {
        var attributes = new Dictionary<string, object>();

        if (IsRequired)
        {
            attributes["aria-required"] = "true";
        }

        if (Disabled || !_hasPermission)
        {
            attributes["aria-disabled"] = "true";
        }

        if (ValidationErrors?.Any() == true)
        {
            attributes["aria-invalid"] = "true";
        }

        return attributes;
    }
}
