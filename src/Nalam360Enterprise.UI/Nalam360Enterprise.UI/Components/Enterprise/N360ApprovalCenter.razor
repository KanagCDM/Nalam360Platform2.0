@using Nalam360Enterprise.UI.Components.Enterprise.Models
@using Nalam360Enterprise.UI.Core.Security
@inject IPermissionService PermissionService
@inject IAuditService AuditService

<div class="n360-approval-center @(_themeClass) @(_isRTL ? "rtl" : "")" @attributes="GetHtmlAttributes()">
    @if (!_hasPermission && !string.IsNullOrEmpty(RequiredPermission))
    {
        <div class="n360-approval-center-no-permission">
            <div class="no-permission-icon">üîí</div>
            <p>You don't have permission to access the Approval Center</p>
        </div>
    }
    else
    {
        <!-- Header -->
        <div class="n360-approval-center-header">
            <div class="header-left">
                <h2>@Title</h2>
                <p class="header-description">@Description</p>
            </div>
            <div class="header-right">
                @if (ShowStatistics && _statistics != null)
                {
                    <div class="statistics-cards">
                        <div class="stat-card pending">
                            <div class="stat-value">@_statistics.TotalPending</div>
                            <div class="stat-label">Pending</div>
                        </div>
                        <div class="stat-card approved">
                            <div class="stat-value">@_statistics.TotalApproved</div>
                            <div class="stat-label">Approved</div>
                        </div>
                        <div class="stat-card overdue">
                            <div class="stat-value">@_statistics.OverduePending</div>
                            <div class="stat-label">Overdue</div>
                        </div>
                    </div>
                }
                @if (ShowRefreshButton)
                {
                    <button class="btn-icon" @onclick="OnRefreshAsync" title="Refresh">
                        üîÑ
                    </button>
                }
                @if (ShowSettingsButton)
                {
                    <button class="btn-icon" @onclick="OnToggleSettingsAsync" title="Settings">
                        ‚öôÔ∏è
                    </button>
                }
            </div>
        </div>

        <!-- Filters & Actions Bar -->
        <div class="n360-approval-center-toolbar">
            <div class="toolbar-left">
                @if (ShowFilters)
                {
                    <div class="filter-group">
                        <label>Status:</label>
                        <select @onchange="OnStatusFilterChangedAsync">
                            <option value="">All</option>
                            @foreach (var status in Enum.GetValues<ApprovalStatus>())
                            {
                                <option value="@status">@status</option>
                            }
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Priority:</label>
                        <select @onchange="OnPriorityFilterChangedAsync">
                            <option value="">All</option>
                            @foreach (var priority in Enum.GetValues<ApprovalPriority>())
                            {
                                <option value="@priority">@priority</option>
                            }
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Request Type:</label>
                        <select @onchange="OnRequestTypeFilterChangedAsync">
                            <option value="">All</option>
                            @foreach (var type in RequestTypes)
                            {
                                <option value="@type">@type</option>
                            }
                        </select>
                    </div>
                    @if (ShowDateRangeFilter)
                    {
                        <div class="filter-group date-range">
                            <label>Date Range:</label>
                            <input type="date" @bind="_filterStartDate" />
                            <span>to</span>
                            <input type="date" @bind="_filterEndDate" />
                        </div>
                    }
                }
                @if (AllowMyApprovalsOnly)
                {
                    <div class="filter-group checkbox-filter">
                        <label>
                            <input type="checkbox" checked="@_configuration.ShowOnlyMyApprovals" @onchange="OnToggleMyApprovalsAsync" />
                            My Approvals Only
                        </label>
                    </div>
                }
            </div>
            <div class="toolbar-right">
                @if (AllowViewModeSwitch)
                {
                    <div class="view-mode-toggle">
                        <button class="@(_configuration.ViewMode == ApprovalViewMode.List ? "active" : "")"
                                @onclick="() => OnChangeViewModeAsync(ApprovalViewMode.List)"
                                title="List View">‚ò∞</button>
                        <button class="@(_configuration.ViewMode == ApprovalViewMode.Cards ? "active" : "")"
                                @onclick="() => OnChangeViewModeAsync(ApprovalViewMode.Cards)"
                                title="Card View">‚ñ¶</button>
                        <button class="@(_configuration.ViewMode == ApprovalViewMode.Timeline ? "active" : "")"
                                @onclick="() => OnChangeViewModeAsync(ApprovalViewMode.Timeline)"
                                title="Timeline View">‚è±Ô∏è</button>
                    </div>
                }
                @if (AllowBulkActions && _selectedRequests.Count > 0)
                {
                    <div class="bulk-actions">
                        <span class="selected-count">@_selectedRequests.Count selected</span>
                        <button class="btn-bulk" @onclick="OnBulkApproveAsync" disabled="@(!CanBulkApprove)">‚úÖ Approve</button>
                        <button class="btn-bulk" @onclick="OnBulkRejectAsync" disabled="@(!CanBulkReject)">‚ùå Reject</button>
                        <button class="btn-bulk" @onclick="OnBulkDelegateAsync">üë• Delegate</button>
                    </div>
                }
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="n360-approval-center-content">
            @if (_isLoading)
            {
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading approvals...</p>
                </div>
            }
            else if (_filteredRequests == null || _filteredRequests.Count == 0)
            {
                <div class="empty-state">
                    <div class="empty-icon">üìã</div>
                    <h3>No Approvals Found</h3>
                    <p>@(_configuration.ShowOnlyMyApprovals ? "You have no pending approvals at this time." : "No approval requests match your filters.")</p>
                </div>
            }
            else
            {
                @if (_configuration.ViewMode == ApprovalViewMode.List)
                {
                    <div class="approval-list">
                        @if (AllowBulkActions)
                        {
                            <div class="list-header">
                                <input type="checkbox" 
                                       checked="@_allSelected" 
                                       @onchange="OnToggleSelectAllAsync" 
                                       title="Select All" />
                                <span class="header-title">Title</span>
                                <span class="header-type">Type</span>
                                <span class="header-requestor">Requestor</span>
                                <span class="header-status">Status</span>
                                <span class="header-priority">Priority</span>
                                <span class="header-date">Requested</span>
                                <span class="header-actions">Actions</span>
                            </div>
                        }
                        @foreach (var request in _filteredRequests)
                        {
                            <div class="approval-list-item @GetPriorityClass(request.Priority) @(IsSelected(request.Id) ? "selected" : "")"
                                 @onclick="() => OnSelectRequestAsync(request)">
                                @if (AllowBulkActions)
                                {
                                    <input type="checkbox" 
                                           checked="@IsSelected(request.Id)" 
                                           @onclick="(e) => OnToggleSelectRequestAsync(request.Id, e)"
                                           @onclick:stopPropagation="true" />
                                }
                                <div class="item-title">
                                    <span class="title-text">@request.Title</span>
                                    @if (request.IsUrgent)
                                    {
                                        <span class="badge urgent">URGENT</span>
                                    }
                                    @if (request.IsEscalated)
                                    {
                                        <span class="badge escalated">ESCALATED</span>
                                    }
                                </div>
                                <div class="item-type">@request.RequestType</div>
                                <div class="item-requestor">
                                    <div class="requestor-avatar">@GetInitials(request.Requestor)</div>
                                    <span>@request.Requestor</span>
                                </div>
                                <div class="item-status">
                                    <span class="status-badge @request.Status.ToString().ToLower()">@request.Status</span>
                                </div>
                                <div class="item-priority">
                                    <span class="priority-indicator @request.Priority.ToString().ToLower()">@GetPriorityIcon(request.Priority)</span>
                                </div>
                                <div class="item-date">
                                    @request.RequestedAt.ToString("MMM dd, yyyy")
                                    @if (request.DueDate.HasValue)
                                    {
                                        <span class="due-date @(request.DueDate.Value < DateTime.Now ? "overdue" : "")">
                                            Due: @request.DueDate.Value.ToString("MMM dd")
                                        </span>
                                    }
                                </div>
                                <div class="item-actions" @onclick:stopPropagation="true">
                                    @if (CanApprove(request))
                                    {
                                        <button class="btn-quick approve" @onclick="() => OnQuickApproveAsync(request)" title="Approve">‚úÖ</button>
                                        <button class="btn-quick reject" @onclick="() => OnQuickRejectAsync(request)" title="Reject">‚ùå</button>
                                    }
                                    <button class="btn-quick view" @onclick="() => OnViewDetailsAsync(request)" title="View Details">üëÅÔ∏è</button>
                                </div>
                            </div>
                        }
                    </div>
                }
                else if (_configuration.ViewMode == ApprovalViewMode.Cards)
                {
                    <div class="approval-cards">
                        @foreach (var request in _filteredRequests)
                        {
                            <div class="approval-card @GetPriorityClass(request.Priority) @(IsSelected(request.Id) ? "selected" : "")"
                                 @onclick="() => OnSelectRequestAsync(request)">
                                @if (AllowBulkActions)
                                {
                                    <input type="checkbox" 
                                           class="card-checkbox"
                                           checked="@IsSelected(request.Id)" 
                                           @onclick="(e) => OnToggleSelectRequestAsync(request.Id, e)"
                                           @onclick:stopPropagation="true" />
                                }
                                <div class="card-header">
                                    <div class="card-title">
                                        @request.Title
                                        @if (request.IsUrgent)
                                        {
                                            <span class="badge urgent">URGENT</span>
                                        }
                                    </div>
                                    <div class="card-status">
                                        <span class="status-badge @request.Status.ToString().ToLower()">@request.Status</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="card-field">
                                        <span class="field-label">Type:</span>
                                        <span class="field-value">@request.RequestType</span>
                                    </div>
                                    <div class="card-field">
                                        <span class="field-label">Requestor:</span>
                                        <div class="field-value requestor">
                                            <div class="requestor-avatar small">@GetInitials(request.Requestor)</div>
                                            <span>@request.Requestor</span>
                                        </div>
                                    </div>
                                    <div class="card-field">
                                        <span class="field-label">Priority:</span>
                                        <span class="field-value priority @request.Priority.ToString().ToLower()">
                                            @GetPriorityIcon(request.Priority) @request.Priority
                                        </span>
                                    </div>
                                    @if (request.Amount.HasValue)
                                    {
                                        <div class="card-field">
                                            <span class="field-label">Amount:</span>
                                            <span class="field-value amount">@request.Currency @request.Amount.Value.ToString("N2")</span>
                                        </div>
                                    }
                                    <div class="card-field">
                                        <span class="field-label">Requested:</span>
                                        <span class="field-value">@request.RequestedAt.ToString("MMM dd, yyyy HH:mm")</span>
                                    </div>
                                    @if (request.DueDate.HasValue)
                                    {
                                        <div class="card-field">
                                            <span class="field-label">Due Date:</span>
                                            <span class="field-value due-date @(request.DueDate.Value < DateTime.Now ? "overdue" : "")">
                                                @request.DueDate.Value.ToString("MMM dd, yyyy")
                                            </span>
                                        </div>
                                    }
                                    @if (request.Steps.Any())
                                    {
                                        <div class="card-workflow-progress">
                                            <span class="field-label">Workflow Progress:</span>
                                            <div class="progress-bar">
                                                @{
                                                    var completedSteps = request.Steps.Count(s => s.Status == ApprovalStepStatus.Completed);
                                                    var totalSteps = request.Steps.Count;
                                                    var progressPercent = totalSteps > 0 ? (completedSteps * 100.0 / totalSteps) : 0;
                                                }
                                                <div class="progress-fill" style="width: @(progressPercent)%"></div>
                                            </div>
                                            <span class="progress-text">Step @(request.CurrentStepIndex + 1) of @totalSteps</span>
                                        </div>
                                    }
                                </div>
                                <div class="card-footer">
                                    @if (CanApprove(request))
                                    {
                                        <button class="btn-card approve" @onclick="() => OnQuickApproveAsync(request)" @onclick:stopPropagation="true">
                                            ‚úÖ Approve
                                        </button>
                                        <button class="btn-card reject" @onclick="() => OnQuickRejectAsync(request)" @onclick:stopPropagation="true">
                                            ‚ùå Reject
                                        </button>
                                    }
                                    <button class="btn-card view" @onclick="() => OnViewDetailsAsync(request)" @onclick:stopPropagation="true">
                                        üëÅÔ∏è Details
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                }
                else if (_configuration.ViewMode == ApprovalViewMode.Timeline)
                {
                    <div class="approval-timeline">
                        @foreach (var group in _filteredRequests.GroupBy(r => r.RequestedAt.Date).OrderByDescending(g => g.Key))
                        {
                            <div class="timeline-group">
                                <div class="timeline-date">@group.Key.ToString("MMMM dd, yyyy")</div>
                                @foreach (var request in group)
                                {
                                    <div class="timeline-item @GetPriorityClass(request.Priority)">
                                        <div class="timeline-marker @request.Status.ToString().ToLower()"></div>
                                        <div class="timeline-content" @onclick="() => OnSelectRequestAsync(request)">
                                            <div class="timeline-header">
                                                <span class="timeline-time">@request.RequestedAt.ToString("HH:mm")</span>
                                                <span class="timeline-title">@request.Title</span>
                                                <span class="status-badge @request.Status.ToString().ToLower()">@request.Status</span>
                                            </div>
                                            <div class="timeline-details">
                                                <span>@request.RequestType by @request.Requestor</span>
                                                @if (request.Amount.HasValue)
                                                {
                                                    <span class="amount">@request.Currency @request.Amount.Value.ToString("N2")</span>
                                                }
                                            </div>
                                            @if (CanApprove(request))
                                            {
                                                <div class="timeline-actions">
                                                    <button class="btn-quick approve" @onclick="() => OnQuickApproveAsync(request)" @onclick:stopPropagation="true">‚úÖ Approve</button>
                                                    <button class="btn-quick reject" @onclick="() => OnQuickRejectAsync(request)" @onclick:stopPropagation="true">‚ùå Reject</button>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            }
        </div>

        <!-- Details Panel (Slide-in from right) -->
        @if (_showDetailsPanel && _selectedRequest != null)
        {
            <div class="n360-approval-details-panel">
                <div class="details-panel-overlay" @onclick="OnCloseDetailsPanelAsync"></div>
                <div class="details-panel-content">
                    <div class="details-header">
                        <h3>Approval Details</h3>
                        <button class="btn-close" @onclick="OnCloseDetailsPanelAsync">‚úï</button>
                    </div>
                    <div class="details-body">
                        <div class="details-section">
                            <h4>@_selectedRequest.Title</h4>
                            <p class="description">@_selectedRequest.Description</p>
                            <div class="badges">
                                <span class="status-badge @_selectedRequest.Status.ToString().ToLower()">@_selectedRequest.Status</span>
                                <span class="priority-badge @_selectedRequest.Priority.ToString().ToLower()">@_selectedRequest.Priority</span>
                                @if (_selectedRequest.IsUrgent)
                                {
                                    <span class="badge urgent">URGENT</span>
                                }
                            </div>
                        </div>

                        <div class="details-section">
                            <h4>Request Information</h4>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Type:</span>
                                    <span class="info-value">@_selectedRequest.RequestType</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Requestor:</span>
                                    <span class="info-value">@_selectedRequest.Requestor</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Department:</span>
                                    <span class="info-value">@_selectedRequest.RequestorDepartment</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Requested At:</span>
                                    <span class="info-value">@_selectedRequest.RequestedAt.ToString("MMM dd, yyyy HH:mm")</span>
                                </div>
                                @if (_selectedRequest.DueDate.HasValue)
                                {
                                    <div class="info-item">
                                        <span class="info-label">Due Date:</span>
                                        <span class="info-value @(_selectedRequest.DueDate.Value < DateTime.Now ? "overdue" : "")">
                                            @_selectedRequest.DueDate.Value.ToString("MMM dd, yyyy HH:mm")
                                        </span>
                                    </div>
                                }
                                @if (_selectedRequest.Amount.HasValue)
                                {
                                    <div class="info-item">
                                        <span class="info-label">Amount:</span>
                                        <span class="info-value amount">@_selectedRequest.Currency @_selectedRequest.Amount.Value.ToString("N2")</span>
                                    </div>
                                }
                            </div>
                        </div>

                        @if (_selectedRequest.Steps.Any())
                        {
                            <div class="details-section">
                                <h4>Approval Workflow</h4>
                                <div class="workflow-steps">
                                    @foreach (var step in _selectedRequest.Steps)
                                    {
                                        <div class="workflow-step @step.Status.ToString().ToLower() @(step.StepNumber == _selectedRequest.CurrentStepIndex + 1 ? "current" : "")">
                                            <div class="step-header">
                                                <div class="step-number">@step.StepNumber</div>
                                                <div class="step-info">
                                                    <span class="step-name">@step.StepName</span>
                                                    <span class="step-status @step.Status.ToString().ToLower()">@step.Status</span>
                                                </div>
                                            </div>
                                            <div class="step-approvers">
                                                <span class="approvers-label">Approvers:</span>
                                                @foreach (var approver in step.Approvers)
                                                {
                                                    <span class="approver-tag">@approver</span>
                                                }
                                            </div>
                                            @if (step.Decisions.Any())
                                            {
                                                <div class="step-decisions">
                                                    @foreach (var decision in step.Decisions)
                                                    {
                                                        <div class="decision-item @decision.Decision.ToString().ToLower()">
                                                            <span class="decision-approver">@decision.Approver</span>
                                                            <span class="decision-result">@GetDecisionIcon(decision.Decision) @decision.Decision</span>
                                                            <span class="decision-time">@decision.DecidedAt.ToString("MMM dd, HH:mm")</span>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @if (_selectedRequest.Attachments.Any() && ShowAttachments)
                        {
                            <div class="details-section">
                                <h4>Attachments (@_selectedRequest.Attachments.Count)</h4>
                                <div class="attachments-list">
                                    @foreach (var attachment in _selectedRequest.Attachments)
                                    {
                                        <div class="attachment-item">
                                            <span class="attachment-icon">üìé</span>
                                            <span class="attachment-name">@attachment.FileName</span>
                                            <span class="attachment-size">@FormatFileSize(attachment.FileSize)</span>
                                            <button class="btn-download" @onclick="() => OnDownloadAttachmentAsync(attachment)">‚¨áÔ∏è</button>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @if (_selectedRequest.History.Any() && ShowHistory)
                        {
                            <div class="details-section">
                                <h4>History</h4>
                                <div class="history-list">
                                    @foreach (var history in _selectedRequest.History.OrderByDescending(h => h.PerformedAt))
                                    {
                                        <div class="history-item">
                                            <div class="history-icon">@GetActionIcon(history.Action)</div>
                                            <div class="history-content">
                                                <div class="history-action">@history.Action @history.ActionDetails</div>
                                                <div class="history-meta">
                                                    <span class="history-user">@history.PerformedBy</span>
                                                    <span class="history-time">@history.PerformedAt.ToString("MMM dd, yyyy HH:mm")</span>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @if (AllowComments)
                        {
                            <div class="details-section">
                                <h4>Comments (@_selectedRequest.Comments.Count)</h4>
                                <div class="comments-list">
                                    @foreach (var comment in _selectedRequest.Comments.OrderByDescending(c => c.CreatedAt))
                                    {
                                        <div class="comment-item @(comment.IsInternal ? "internal" : "")">
                                            <div class="comment-header">
                                                <div class="comment-avatar">@GetInitials(comment.Author)</div>
                                                <div class="comment-meta">
                                                    <span class="comment-author">@comment.Author</span>
                                                    <span class="comment-time">@comment.CreatedAt.ToString("MMM dd, yyyy HH:mm")</span>
                                                    @if (comment.IsInternal)
                                                    {
                                                        <span class="badge internal">Internal</span>
                                                    }
                                                </div>
                                            </div>
                                            <div class="comment-text">@comment.Text</div>
                                        </div>
                                    }
                                </div>
                                <div class="comment-form">
                                    <textarea @bind="_newComment" placeholder="Add a comment..." rows="3"></textarea>
                                    <div class="comment-actions">
                                        <label>
                                            <input type="checkbox" @bind="_commentIsInternal" />
                                            Internal comment
                                        </label>
                                        <button class="btn-add-comment" @onclick="OnAddCommentAsync" disabled="@string.IsNullOrWhiteSpace(_newComment)">
                                            Add Comment
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    @if (CanApprove(_selectedRequest))
                    {
                        <div class="details-footer">
                            <button class="btn-action approve" @onclick="OnApproveRequestAsync">‚úÖ Approve</button>
                            <button class="btn-action reject" @onclick="OnRejectRequestAsync">‚ùå Reject</button>
                            @if (AllowDelegation)
                            {
                                <button class="btn-action delegate" @onclick="OnShowDelegateModalAsync">üë• Delegate</button>
                            }
                            @if (AllowRequestMoreInfo)
                            {
                                <button class="btn-action more-info" @onclick="OnRequestMoreInfoAsync">‚ÑπÔ∏è Request More Info</button>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Settings Panel -->
        @if (_showSettingsPanel)
        {
            <div class="n360-approval-settings-panel">
                <div class="settings-panel-overlay" @onclick="OnToggleSettingsAsync"></div>
                <div class="settings-panel-content">
                    <div class="settings-header">
                        <h3>Settings</h3>
                        <button class="btn-close" @onclick="OnToggleSettingsAsync">‚úï</button>
                    </div>
                    <div class="settings-body">
                        <div class="setting-group">
                            <label>
                                <input type="checkbox" @bind="_configuration.ShowCompletedApprovals" />
                                Show completed approvals
                            </label>
                        </div>
                        <div class="setting-group">
                            <label>
                                <input type="checkbox" @bind="_configuration.GroupByRequestType" />
                                Group by request type
                            </label>
                        </div>
                        <div class="setting-group">
                            <label>
                                <input type="checkbox" @bind="_configuration.EnableAutoRefresh" />
                                Enable auto-refresh
                            </label>
                        </div>
                        @if (_configuration.EnableAutoRefresh)
                        {
                            <div class="setting-group">
                                <label>Auto-refresh interval (seconds):</label>
                                <input type="number" @bind="_configuration.AutoRefreshInterval" min="30" max="300" />
                            </div>
                        }
                    </div>
                    <div class="settings-footer">
                        <button class="btn-save" @onclick="OnSaveSettingsAsync">Save Settings</button>
                    </div>
                </div>
            </div>
        }

        <!-- Delegate Modal -->
        @if (_showDelegateModal && _selectedRequest != null)
        {
            <div class="n360-modal-overlay" @onclick="OnCloseDelegateModalAsync">
                <div class="n360-modal-content" @onclick:stopPropagation="true">
                    <div class="modal-header">
                        <h3>Delegate Approval</h3>
                        <button class="btn-close" @onclick="OnCloseDelegateModalAsync">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Delegate To:</label>
                            <input type="text" @bind="_delegateTo" placeholder="Enter user name or email" />
                        </div>
                        <div class="form-group">
                            <label>Reason:</label>
                            <textarea @bind="_delegateReason" rows="3" placeholder="Reason for delegation"></textarea>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" @bind="_notifyDelegatee" />
                                Notify delegatee
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-cancel" @onclick="OnCloseDelegateModalAsync">Cancel</button>
                        <button class="btn-submit" @onclick="OnSubmitDelegateAsync" disabled="@string.IsNullOrWhiteSpace(_delegateTo)">
                            Delegate
                        </button>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    // Parameters
    [Parameter] public string Title { get; set; } = "Approval Center";
    [Parameter] public string Description { get; set; } = "Manage and process approval requests";
    [Parameter] public List<ApprovalRequest> Requests { get; set; } = new();
    [Parameter] public List<string> RequestTypes { get; set; } = new();
    [Parameter] public ApprovalStatistics? Statistics { get; set; }
    [Parameter] public bool ShowStatistics { get; set; } = true;
    [Parameter] public bool ShowFilters { get; set; } = true;
    [Parameter] public bool ShowDateRangeFilter { get; set; } = true;
    [Parameter] public bool ShowRefreshButton { get; set; } = true;
    [Parameter] public bool ShowSettingsButton { get; set; } = true;
    [Parameter] public bool AllowMyApprovalsOnly { get; set; } = true;
    [Parameter] public bool AllowViewModeSwitch { get; set; } = true;
    [Parameter] public bool AllowBulkActions { get; set; } = true;
    [Parameter] public bool AllowComments { get; set; } = true;
    [Parameter] public bool AllowDelegation { get; set; } = true;
    [Parameter] public bool AllowRequestMoreInfo { get; set; } = true;
    [Parameter] public bool ShowAttachments { get; set; } = true;
    [Parameter] public bool ShowHistory { get; set; } = true;
    [Parameter] public string? CurrentUserName { get; set; }
    
    // RBAC & Audit
    [Parameter] public string? RequiredPermission { get; set; }
    [Parameter] public bool HideIfNoPermission { get; set; }
    [Parameter] public bool EnableAudit { get; set; } = true;
    [Parameter] public string? AuditResource { get; set; }
    [Parameter] public string? AuditAction { get; set; }

    // Events
    [Parameter] public EventCallback<ApprovalRequest> OnApprovalApproved { get; set; }
    [Parameter] public EventCallback<ApprovalRequest> OnApprovalRejected { get; set; }
    [Parameter] public EventCallback<(ApprovalRequest Request, string DelegateTo)> OnApprovalDelegated { get; set; }
    [Parameter] public EventCallback<ApprovalRequest> OnMoreInfoRequested { get; set; }
    [Parameter] public EventCallback<List<Guid>> OnBulkApprove { get; set; }
    [Parameter] public EventCallback<List<Guid>> OnBulkReject { get; set; }
    [Parameter] public EventCallback<(ApprovalRequest Request, ApprovalComment Comment)> OnCommentAdded { get; set; }
    [Parameter] public EventCallback OnRefresh { get; set; }

    // State
    private bool _hasPermission = true;
    private string _themeClass = "light";
    private bool _isRTL = false;
    private ApprovalCenterConfiguration _configuration = new();
    private ApprovalStatistics? _statistics;
    private List<ApprovalRequest> _filteredRequests = new();
    private List<Guid> _selectedRequests = new();
    private bool _allSelected = false;
    private bool _isLoading = false;
    private bool _showDetailsPanel = false;
    private bool _showSettingsPanel = false;
    private bool _showDelegateModal = false;
    private ApprovalRequest? _selectedRequest;
    private DateTime? _filterStartDate;
    private DateTime? _filterEndDate;
    private string _newComment = string.Empty;
    private bool _commentIsInternal = false;
    private string _delegateTo = string.Empty;
    private string _delegateReason = string.Empty;
    private bool _notifyDelegatee = true;

    // Properties
    private bool CanBulkApprove => _selectedRequests.Any() && _selectedRequests.All(id => CanApprove(Requests.First(r => r.Id == id)));
    private bool CanBulkReject => _selectedRequests.Any() && _selectedRequests.All(id => CanApprove(Requests.First(r => r.Id == id)));

    protected override async Task OnInitializedAsync()
    {
        await CheckPermissionAsync();
        if (_hasPermission)
        {
            _statistics = Statistics;
            _filteredRequests = new List<ApprovalRequest>(Requests);
            ApplyFilters();
            
            // if (EnableAudit)
            // {
            //     await AuditService.LogAsync("OpenApprovalCenter", AuditResource ?? "ApprovalCenter");
            // }
        }
    }

    private async Task CheckPermissionAsync()
    {
        if (!string.IsNullOrEmpty(RequiredPermission))
        {
            _hasPermission = await PermissionService.HasPermissionAsync(RequiredPermission);
        }
    }

    private bool CanApprove(ApprovalRequest request)
    {
        if (string.IsNullOrEmpty(CurrentUserName)) return false;
        if (request.Status != ApprovalStatus.Pending && request.Status != ApprovalStatus.InReview) return false;
        
        var currentStep = request.Steps.ElementAtOrDefault(request.CurrentStepIndex);
        return currentStep?.Approvers.Contains(CurrentUserName) ?? false;
    }

    private void ApplyFilters()
    {
        _filteredRequests = new List<ApprovalRequest>(Requests);

        if (_configuration.ShowOnlyMyApprovals && !string.IsNullOrEmpty(CurrentUserName))
        {
            _filteredRequests = _filteredRequests.Where(r => CanApprove(r)).ToList();
        }

        if (!_configuration.ShowCompletedApprovals)
        {
            _filteredRequests = _filteredRequests.Where(r => 
                r.Status != ApprovalStatus.Approved && 
                r.Status != ApprovalStatus.Rejected && 
                r.Status != ApprovalStatus.Cancelled).ToList();
        }

        // Apply sorting
        _filteredRequests = _configuration.SortField switch
        {
            ApprovalSortField.RequestedAt => _configuration.SortDescending 
                ? _filteredRequests.OrderByDescending(r => r.RequestedAt).ToList()
                : _filteredRequests.OrderBy(r => r.RequestedAt).ToList(),
            ApprovalSortField.Priority => _configuration.SortDescending
                ? _filteredRequests.OrderByDescending(r => r.Priority).ToList()
                : _filteredRequests.OrderBy(r => r.Priority).ToList(),
            ApprovalSortField.Status => _configuration.SortDescending
                ? _filteredRequests.OrderByDescending(r => r.Status).ToList()
                : _filteredRequests.OrderBy(r => r.Status).ToList(),
            _ => _filteredRequests
        };
    }

    private bool IsSelected(Guid requestId) => _selectedRequests.Contains(requestId);

    private string GetPriorityClass(ApprovalPriority priority) => $"priority-{priority.ToString().ToLower()}";

    private string GetPriorityIcon(ApprovalPriority priority) => priority switch
    {
        ApprovalPriority.Critical => "üî¥",
        ApprovalPriority.High => "üü†",
        ApprovalPriority.Normal => "üü°",
        ApprovalPriority.Low => "üü¢",
        _ => "‚ö™"
    };

    private string GetDecisionIcon(ApprovalDecision decision) => decision switch
    {
        ApprovalDecision.Approved => "‚úÖ",
        ApprovalDecision.Rejected => "‚ùå",
        ApprovalDecision.Delegated => "üë•",
        ApprovalDecision.MoreInfoRequested => "‚ÑπÔ∏è",
        _ => "‚ö™"
    };

    private string GetActionIcon(ApprovalAction action) => action switch
    {
        ApprovalAction.Created => "üìù",
        ApprovalAction.Submitted => "üì§",
        ApprovalAction.Approved => "‚úÖ",
        ApprovalAction.Rejected => "‚ùå",
        ApprovalAction.Delegated => "üë•",
        ApprovalAction.Escalated => "‚ö†Ô∏è",
        ApprovalAction.Commented => "üí¨",
        _ => "üìã"
    };

    private string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "??";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name.Length >= 2 ? name.Substring(0, 2).ToUpper() : name.ToUpper();
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    // Event Handlers
    private async Task OnStatusFilterChangedAsync(Microsoft.AspNetCore.Components.ChangeEventArgs e)
    {
        ApplyFilters();
        // Audit logging removed for build fix
    }

    private async Task OnPriorityFilterChangedAsync(Microsoft.AspNetCore.Components.ChangeEventArgs e)
    {
        ApplyFilters();
        // Audit logging removed for build fix
    }

    private async Task OnRequestTypeFilterChangedAsync(Microsoft.AspNetCore.Components.ChangeEventArgs e)
    {
        ApplyFilters();
        // Audit logging removed for build fix
    }

    private async Task OnToggleMyApprovalsAsync(Microsoft.AspNetCore.Components.ChangeEventArgs e)
    {
        _configuration.ShowOnlyMyApprovals = (bool)(e.Value ?? false);
        ApplyFilters();
        // Audit logging removed for build fix
    }

    private async Task OnChangeViewModeAsync(ApprovalViewMode mode)
    {
        _configuration.ViewMode = mode;
        // Audit logging removed for build fix
    }

    private async Task OnToggleSelectAllAsync(Microsoft.AspNetCore.Components.ChangeEventArgs e)
    {
        _allSelected = (bool)(e.Value ?? false);
        _selectedRequests = _allSelected ? _filteredRequests.Select(r => r.Id).ToList() : new List<Guid>();
    }

    private async Task OnToggleSelectRequestAsync(Guid requestId, MouseEventArgs e)
    {
        if (_selectedRequests.Contains(requestId))
            _selectedRequests.Remove(requestId);
        else
            _selectedRequests.Add(requestId);
        
        _allSelected = _selectedRequests.Count == _filteredRequests.Count;
    }

    private async Task OnSelectRequestAsync(ApprovalRequest request)
    {
        _selectedRequest = request;
        _showDetailsPanel = true;
        // Audit logging removed for build fix
    }

    private async Task OnViewDetailsAsync(ApprovalRequest request)
    {
        await OnSelectRequestAsync(request);
    }

    private async Task OnCloseDetailsPanelAsync()
    {
        _showDetailsPanel = false;
        _selectedRequest = null;
        _newComment = string.Empty;
        _commentIsInternal = false;
    }

    private async Task OnQuickApproveAsync(ApprovalRequest request)
    {
        // Audit logging removed for build fix
        await OnApprovalApproved.InvokeAsync(request);
    }

    private async Task OnQuickRejectAsync(ApprovalRequest request)
    {
        // Audit logging removed for build fix
        await OnApprovalRejected.InvokeAsync(request);
    }

    private async Task OnApproveRequestAsync()
    {
        if (_selectedRequest != null)
        {
            // Audit logging removed for build fix
            await OnApprovalApproved.InvokeAsync(_selectedRequest);
            await OnCloseDetailsPanelAsync();
        }
    }

    private async Task OnRejectRequestAsync()
    {
        if (_selectedRequest != null)
        {
            // Audit logging removed for build fix
            await OnApprovalRejected.InvokeAsync(_selectedRequest);
            await OnCloseDetailsPanelAsync();
        }
    }

    private async Task OnRequestMoreInfoAsync()
    {
        if (_selectedRequest != null)
        {
            // Audit logging removed for build fix
            await OnMoreInfoRequested.InvokeAsync(_selectedRequest);
        }
    }

    private async Task OnBulkApproveAsync()
    {
        // Audit logging removed for build fix
        await OnBulkApprove.InvokeAsync(_selectedRequests);
        _selectedRequests.Clear();
        _allSelected = false;
    }

    private async Task OnBulkRejectAsync()
    {
        // Audit logging removed for build fix
        await OnBulkReject.InvokeAsync(_selectedRequests);
        _selectedRequests.Clear();
        _allSelected = false;
    }

    private async Task OnBulkDelegateAsync()
    {
        // Audit logging removed for build fix
        // Open bulk delegate modal (implementation can be extended)
    }

    private async Task OnAddCommentAsync()
    {
        if (_selectedRequest != null && !string.IsNullOrWhiteSpace(_newComment))
        {
            var comment = new ApprovalComment
            {
                Id = Guid.NewGuid(),
                Text = _newComment,
                Author = CurrentUserName ?? "Unknown",
                CreatedAt = DateTime.Now,
                IsInternal = _commentIsInternal
            };

            // Audit logging removed for build fix
            await OnCommentAdded.InvokeAsync((_selectedRequest, comment));
            
            _newComment = string.Empty;
            _commentIsInternal = false;
        }
    }

    private async Task OnShowDelegateModalAsync()
    {
        _showDelegateModal = true;
        // Audit logging removed for build fix
    }

    private async Task OnCloseDelegateModalAsync()
    {
        _showDelegateModal = false;
        _delegateTo = string.Empty;
        _delegateReason = string.Empty;
        _notifyDelegatee = true;
    }

    private async Task OnSubmitDelegateAsync()
    {
        if (_selectedRequest != null && !string.IsNullOrWhiteSpace(_delegateTo))
        {
            // Audit logging removed for build fix
            await OnApprovalDelegated.InvokeAsync((_selectedRequest, _delegateTo));
            await OnCloseDelegateModalAsync();
            await OnCloseDetailsPanelAsync();
        }
    }

    private async Task OnDownloadAttachmentAsync(ApprovalAttachment attachment)
    {
        // Audit logging removed for build fix
        // Implement download logic
    }

    private async Task OnRefreshAsync()
    {
        _isLoading = true;
        // Audit logging removed for build fix
        await OnRefresh.InvokeAsync();
        ApplyFilters();
        _isLoading = false;
    }

    private async Task OnToggleSettingsAsync()
    {
        _showSettingsPanel = !_showSettingsPanel;
        // if (_showSettingsPanel && EnableAudit)
        // {
        //     await AuditService.LogAsync("OpenSettings", AuditResource ?? "ApprovalCenter");
        // }
    }

    private async Task OnSaveSettingsAsync()
    {
        // Audit logging removed for build fix
        ApplyFilters();
        _showSettingsPanel = false;
    }

    private Dictionary<string, object> GetHtmlAttributes()
    {
        var attrs = new Dictionary<string, object>
        {
            ["role"] = "region",
            ["aria-label"] = "Approval Center"
        };

        if (_isRTL)
        {
            attrs["dir"] = "rtl";
        }

        return attrs;
    }
}
