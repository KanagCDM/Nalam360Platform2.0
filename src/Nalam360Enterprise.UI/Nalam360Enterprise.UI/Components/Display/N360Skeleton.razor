@using Nalam360Enterprise.UI.Core.Security

@inject IPermissionService? PermissionService

@if (!HideIfNoPermission || _hasPermission)
{
    <div class="n360-skeleton @GetSkeletonClass()" style="@GetSkeletonStyle()" @attributes="GetHtmlAttributes()">
        @if (Variant == SkeletonVariant.Text)
        {
            @for (int i = 0; i < Rows; i++)
            {
                <div class="n360-skeleton__line" style="@GetLineStyle(i)"></div>
            }
        }
        else if (Variant == SkeletonVariant.Circle)
        {
            <div class="n360-skeleton__circle"></div>
        }
        else if (Variant == SkeletonVariant.Rectangle)
        {
            <div class="n360-skeleton__rectangle"></div>
        }
        else if (Variant == SkeletonVariant.Avatar)
        {
            <div class="n360-skeleton__avatar">
                <div class="n360-skeleton__avatar-circle"></div>
                <div class="n360-skeleton__avatar-content">
                    <div class="n360-skeleton__line" style="width: 80%"></div>
                    <div class="n360-skeleton__line" style="width: 60%"></div>
                </div>
            </div>
        }
        else if (Variant == SkeletonVariant.Card)
        {
            <div class="n360-skeleton__card">
                <div class="n360-skeleton__card-image"></div>
                <div class="n360-skeleton__card-content">
                    <div class="n360-skeleton__line" style="width: 90%"></div>
                    <div class="n360-skeleton__line" style="width: 70%"></div>
                    <div class="n360-skeleton__line" style="width: 50%"></div>
                </div>
            </div>
        }
        else if (Variant == SkeletonVariant.Custom && ChildContent != null)
        {
            @ChildContent
        }
    </div>
}

@code {
    [Parameter] public SkeletonVariant Variant { get; set; } = SkeletonVariant.Text;
    [Parameter] public int Rows { get; set; } = 3;
    [Parameter] public string? Width { get; set; }
    [Parameter] public string? Height { get; set; }
    [Parameter] public bool Active { get; set; } = true;
    [Parameter] public bool Round { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }

    // Styling
    [Parameter] public string? CssClass { get; set; }
    [Parameter] public bool IsRtl { get; set; }

    // RBAC
    [Parameter] public string? RequiredPermission { get; set; }
    [Parameter] public bool HideIfNoPermission { get; set; }

    private bool _hasPermission = true;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(RequiredPermission) && PermissionService != null)
        {
            _hasPermission = await PermissionService.HasPermissionAsync(RequiredPermission);
        }
    }

    private string GetSkeletonClass()
    {
        var classes = new List<string> 
        { 
            "n360-skeleton",
            $"n360-skeleton--{Variant.ToString().ToLower()}"
        };

        if (Active)
        {
            classes.Add("n360-skeleton--active");
        }

        if (Round)
        {
            classes.Add("n360-skeleton--round");
        }

        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }

        return string.Join(" ", classes);
    }

    private string GetSkeletonStyle()
    {
        var styles = new List<string>();

        if (!string.IsNullOrEmpty(Width))
        {
            styles.Add($"width: {Width}");
        }

        if (!string.IsNullOrEmpty(Height))
        {
            styles.Add($"height: {Height}");
        }

        return styles.Any() ? string.Join("; ", styles) : string.Empty;
    }

    private string GetLineStyle(int index)
    {
        if (index == Rows - 1 && Rows > 1)
        {
            return "width: 60%"; // Last line shorter
        }
        return string.Empty;
    }

    private Dictionary<string, object> GetHtmlAttributes()
    {
        var attributes = new Dictionary<string, object>();

        if (IsRtl)
        {
            attributes["dir"] = "rtl";
        }

        attributes["aria-busy"] = "true";
        attributes["aria-live"] = "polite";

        return attributes;
    }
}
