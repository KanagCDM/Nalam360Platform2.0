@using Nalam360Enterprise.UI.Models
@using Nalam360Enterprise.UI.Core.Security
@using Microsoft.AspNetCore.Components.Forms
@using ProfileSection = Nalam360Enterprise.UI.Models.ProfileSection
@typeparam TProfile where TProfile : UserProfile
@inject IPermissionService PermissionService
@inject IAuditService AuditService

<div class="n360-profile-editor @CssClass" dir="@(IsRtl ? "rtl" : "ltr")">
    @if (ShowAvatar && Profile != null)
    {
        <div class="n360-profile-editor__avatar-section">
            <div class="n360-profile-editor__avatar-container">
                @if (!string.IsNullOrEmpty(Profile.AvatarUrl))
                {
                    <img src="@Profile.AvatarUrl" alt="Avatar" class="n360-profile-editor__avatar-image" />
                }
                else
                {
                    <div class="n360-profile-editor__avatar-placeholder">
                        @GetInitials()
                    </div>
                }
                @if (AllowAvatarUpload && !IsReadOnly)
                {
                    <label class="n360-profile-editor__avatar-upload-btn">
                        <InputFile OnChange="@HandleAvatarUpload" accept="@string.Join(",", Options.AllowedAvatarTypes)" style="display: none;" />
                        üì∑
                    </label>
                }
            </div>
            <div class="n360-profile-editor__avatar-info">
                <h2 class="n360-profile-editor__display-name">@(Profile.DisplayName ?? Profile.UserName)</h2>
                <p class="n360-profile-editor__email">@Profile.Email</p>
                @if (Profile.EmailVerified)
                {
                    <span class="n360-profile-editor__badge n360-profile-editor__badge--verified">‚úì Verified</span>
                }
            </div>
        </div>
    }

    @if (ShowTabs)
    {
        <div class="n360-profile-editor__tabs">
            @foreach (var sec in GetVisibleSections())
            {
                <button type="button" 
                        class="n360-profile-editor__tab @(ActiveSection == sec ? "n360-profile-editor__tab--active" : "")"
                        @onclick="() => SetActiveSection(sec)">
                    @GetSectionIcon(sec) @sec.ToString()
                </button>
            }
        </div>
    }

    <div class="n360-profile-editor__content">
        @if (Profile != null)
        {
            <EditForm Model="@Profile" OnValidSubmit="HandleSubmit">
                @if (ActiveSection == ProfileSection.Personal)
                {
                    <div class="n360-profile-editor__section">
                        <h3 class="n360-profile-editor__section-title">Personal Information</h3>
                        
                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">First Name</label>
                            <input type="text" class="n360-profile-editor__input" 
                                   @bind="Profile.FirstName" disabled="@IsReadOnly" />
                        </div>

                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">Last Name</label>
                            <input type="text" class="n360-profile-editor__input" 
                                   @bind="Profile.LastName" disabled="@IsReadOnly" />
                        </div>

                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">Display Name</label>
                            <input type="text" class="n360-profile-editor__input" 
                                   @bind="Profile.DisplayName" disabled="@IsReadOnly" />
                        </div>

                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">Date of Birth</label>
                            <input type="date" class="n360-profile-editor__input" 
                                   value="@(Profile.DateOfBirth?.ToString("yyyy-MM-dd"))"
                                   @onchange="e => Profile.DateOfBirth = DateTime.Parse(e.Value?.ToString() ?? DateTime.Now.ToString())"
                                   disabled="@IsReadOnly" />
                        </div>

                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">Gender</label>
                            <select class="n360-profile-editor__input" @bind="Profile.Gender" disabled="@IsReadOnly">
                                <option value="">Select...</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                                <option value="PreferNotToSay">Prefer not to say</option>
                            </select>
                        </div>

                        <div class="n360-profile-editor__field n360-profile-editor__field--full">
                            <label class="n360-profile-editor__label">Bio</label>
                            <textarea class="n360-profile-editor__textarea" rows="4"
                                      @bind="Profile.Bio" disabled="@IsReadOnly" 
                                      placeholder="Tell us about yourself..."></textarea>
                        </div>
                    </div>
                }

                @if (ActiveSection == ProfileSection.Contact)
                {
                    <div class="n360-profile-editor__section">
                        <h3 class="n360-profile-editor__section-title">Contact Information</h3>
                        
                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">Email</label>
                            <div class="n360-profile-editor__field-group">
                                <input type="email" class="n360-profile-editor__input" 
                                       @bind="Profile.Email" disabled="@IsReadOnly" />
                                @if (Profile.EmailVerified)
                                {
                                    <span class="n360-profile-editor__verified">‚úì</span>
                                }
                            </div>
                        </div>

                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">Phone Number</label>
                            <div class="n360-profile-editor__field-group">
                                <input type="tel" class="n360-profile-editor__input" 
                                       @bind="Profile.PhoneNumber" disabled="@IsReadOnly" />
                                @if (Profile.PhoneVerified)
                                {
                                    <span class="n360-profile-editor__verified">‚úì</span>
                                }
                            </div>
                        </div>

                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">Mobile Number</label>
                            <input type="tel" class="n360-profile-editor__input" 
                                   @bind="Profile.MobileNumber" disabled="@IsReadOnly" />
                        </div>

                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">Location</label>
                            <input type="text" class="n360-profile-editor__input" 
                                   @bind="Profile.Location" disabled="@IsReadOnly" 
                                   placeholder="City, Country" />
                        </div>

                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">Time Zone</label>
                            <input type="text" class="n360-profile-editor__input" 
                                   @bind="Profile.TimeZone" disabled="@IsReadOnly" />
                        </div>

                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">Language</label>
                            <select class="n360-profile-editor__input" @bind="Profile.Language" disabled="@IsReadOnly">
                                <option value="">Select...</option>
                                <option value="en">English</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="ar">Arabic</option>
                            </select>
                        </div>
                    </div>
                }

                @if (ActiveSection == ProfileSection.Professional)
                {
                    <div class="n360-profile-editor__section">
                        <h3 class="n360-profile-editor__section-title">Professional Information</h3>
                        
                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">Job Title</label>
                            <input type="text" class="n360-profile-editor__input" 
                                   @bind="Profile.JobTitle" disabled="@IsReadOnly" />
                        </div>

                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">Department</label>
                            <input type="text" class="n360-profile-editor__input" 
                                   @bind="Profile.Department" disabled="@IsReadOnly" />
                        </div>

                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">Company</label>
                            <input type="text" class="n360-profile-editor__input" 
                                   @bind="Profile.Company" disabled="@IsReadOnly" />
                        </div>

                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">Website</label>
                            <input type="url" class="n360-profile-editor__input" 
                                   @bind="Profile.Website" disabled="@IsReadOnly" 
                                   placeholder="https://..." />
                        </div>
                    </div>
                }

                @if (ActiveSection == ProfileSection.Social)
                {
                    <div class="n360-profile-editor__section">
                        <h3 class="n360-profile-editor__section-title">Social Links</h3>
                        
                        @foreach (var platform in SocialPlatforms)
                        {
                            <div class="n360-profile-editor__field">
                                <label class="n360-profile-editor__label">@platform.Icon @platform.Label</label>
                                <input type="url" class="n360-profile-editor__input" 
                                       value="@GetSocialLink(platform.Platform)"
                                       @onchange="e => SetSocialLink(platform.Platform, e.Value?.ToString())"
                                       disabled="@IsReadOnly" 
                                       placeholder="@platform.Placeholder" />
                            </div>
                        }
                    </div>
                }

                @if (ActiveSection == ProfileSection.Security && ShowPasswordChange)
                {
                    <div class="n360-profile-editor__section">
                        <h3 class="n360-profile-editor__section-title">Security Settings</h3>
                        
                        @if (!IsReadOnly)
                        {
                            <div class="n360-profile-editor__password-section">
                                <h4>Change Password</h4>
                                
                                <div class="n360-profile-editor__field">
                                    <label class="n360-profile-editor__label">Current Password</label>
                                    <input type="password" class="n360-profile-editor__input" 
                                           @bind="_passwordChange.CurrentPassword" />
                                </div>

                                <div class="n360-profile-editor__field">
                                    <label class="n360-profile-editor__label">New Password</label>
                                    <input type="password" class="n360-profile-editor__input" 
                                           @bind="_passwordChange.NewPassword"
                                           @oninput="HandlePasswordInput" />
                                    @if (!string.IsNullOrEmpty(_passwordChange.NewPassword))
                                    {
                                        <div class="n360-profile-editor__password-strength">
                                            <div class="n360-profile-editor__password-strength-bar" 
                                                 style="width: @(GetPasswordStrength())%">
                                            </div>
                                        </div>
                                        <span class="n360-profile-editor__password-strength-text">
                                            @GetPasswordStrengthLabel()
                                        </span>
                                    }
                                </div>

                                <div class="n360-profile-editor__field">
                                    <label class="n360-profile-editor__label">Confirm Password</label>
                                    <input type="password" class="n360-profile-editor__input" 
                                           @bind="_passwordChange.ConfirmPassword" />
                                </div>

                                <button type="button" class="n360-profile-editor__btn n360-profile-editor__btn--secondary"
                                        @onclick="HandlePasswordChange">
                                    Change Password
                                </button>
                            </div>
                        }

                        @if (ShowTwoFactor)
                        {
                            <div class="n360-profile-editor__2fa-section">
                                <h4>Two-Factor Authentication</h4>
                                <label class="n360-profile-editor__checkbox">
                                    <input type="checkbox" @bind="Profile.Security.TwoFactorEnabled" 
                                           disabled="@IsReadOnly" />
                                    <span>Enable two-factor authentication</span>
                                </label>
                                
                                @if (Profile.Security.TwoFactorEnabled)
                                {
                                    <div class="n360-profile-editor__field">
                                        <label class="n360-profile-editor__label">Method</label>
                                        <select class="n360-profile-editor__input" 
                                                @bind="Profile.Security.TwoFactorMethod" 
                                                disabled="@IsReadOnly">
                                            <option value="SMS">SMS</option>
                                            <option value="Email">Email</option>
                                            <option value="App">Authenticator App</option>
                                        </select>
                                    </div>
                                }
                            </div>
                        }

                        @if (Profile.Security.LastPasswordChange.HasValue)
                        {
                            <div class="n360-profile-editor__info">
                                Last password change: @Profile.Security.LastPasswordChange.Value.ToString("MMM dd, yyyy")
                            </div>
                        }
                    </div>
                }

                @if (ActiveSection == ProfileSection.Preferences)
                {
                    <div class="n360-profile-editor__section">
                        <h3 class="n360-profile-editor__section-title">Preferences</h3>
                        
                        <label class="n360-profile-editor__checkbox">
                            <input type="checkbox" @bind="Profile.Preferences.ReceiveEmailNotifications" 
                                   disabled="@IsReadOnly" />
                            <span>Receive email notifications</span>
                        </label>

                        <label class="n360-profile-editor__checkbox">
                            <input type="checkbox" @bind="Profile.Preferences.ReceiveSmsNotifications" 
                                   disabled="@IsReadOnly" />
                            <span>Receive SMS notifications</span>
                        </label>

                        <label class="n360-profile-editor__checkbox">
                            <input type="checkbox" @bind="Profile.Preferences.ShowOnlineStatus" 
                                   disabled="@IsReadOnly" />
                            <span>Show online status</span>
                        </label>

                        <label class="n360-profile-editor__checkbox">
                            <input type="checkbox" @bind="Profile.Preferences.AllowMessaging" 
                                   disabled="@IsReadOnly" />
                            <span>Allow direct messaging</span>
                        </label>

                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">Theme</label>
                            <select class="n360-profile-editor__input" 
                                    @bind="Profile.Preferences.Theme" 
                                    disabled="@IsReadOnly">
                                <option value="Light">Light</option>
                                <option value="Dark">Dark</option>
                                <option value="Auto">Auto</option>
                            </select>
                        </div>

                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">Date Format</label>
                            <select class="n360-profile-editor__input" 
                                    @bind="Profile.Preferences.DateFormat" 
                                    disabled="@IsReadOnly">
                                <option value="MM/dd/yyyy">MM/DD/YYYY</option>
                                <option value="dd/MM/yyyy">DD/MM/YYYY</option>
                                <option value="yyyy-MM-dd">YYYY-MM-DD</option>
                            </select>
                        </div>

                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">Time Format</label>
                            <select class="n360-profile-editor__input" 
                                    @bind="Profile.Preferences.TimeFormat" 
                                    disabled="@IsReadOnly">
                                <option value="12h">12 Hour</option>
                                <option value="24h">24 Hour</option>
                            </select>
                        </div>

                        <div class="n360-profile-editor__field">
                            <label class="n360-profile-editor__label">Privacy Level</label>
                            <select class="n360-profile-editor__input" 
                                    @bind="Profile.Preferences.PrivacyLevel" 
                                    disabled="@IsReadOnly">
                                <option value="Public">Public</option>
                                <option value="Friends">Friends Only</option>
                                <option value="Private">Private</option>
                            </select>
                        </div>
                    </div>
                }

                @if (!IsReadOnly)
                {
                    <div class="n360-profile-editor__actions">
                        @if (ShowSaveButton)
                        {
                            <button type="submit" class="n360-profile-editor__btn n360-profile-editor__btn--primary">
                                üíæ Save Changes
                            </button>
                        }
                        @if (ShowCancelButton)
                        {
                            <button type="button" class="n360-profile-editor__btn n360-profile-editor__btn--secondary"
                                    @onclick="HandleCancel">
                                Cancel
                            </button>
                        }
                        @if (ShowDeleteAccount)
                        {
                            <button type="button" class="n360-profile-editor__btn n360-profile-editor__btn--danger"
                                    @onclick="HandleDeleteAccount">
                                üóëÔ∏è Delete Account
                            </button>
                        }
                    </div>
                }
            </EditForm>
        }
    </div>
</div>
