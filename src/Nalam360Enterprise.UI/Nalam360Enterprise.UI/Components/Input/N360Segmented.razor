@using Nalam360Enterprise.UI.Core.Security
@typeparam TValue
@typeparam TOption

@inject IPermissionService? PermissionService
@inject IAuditService? AuditService

@if (!HideIfNoPermission || _hasPermission)
{
    <div class="@GetSegmentedClass()" style="@Style" @attributes="@GetHtmlAttributes()">
        @foreach (var option in Options)
        {
            var isSelected = EqualityComparer<TValue>.Default.Equals(ValueSelector(option), Value);
            var isDisabled = DisabledPredicate?.Invoke(option) ?? false;
            
            <div class="n360-segmented__item @(isSelected ? "n360-segmented__item--selected" : "") @(isDisabled ? "n360-segmented__item--disabled" : "")"
                 @onclick="() => HandleSelectAsync(option)">
                @if (IconSelector != null && IconSelector(option) != null)
                {
                    <span class="n360-segmented__icon">@IconSelector(option)</span>
                }
                <span class="n360-segmented__label">@LabelSelector(option)</span>
            </div>
        }
        <div class="n360-segmented__indicator" style="@GetIndicatorStyle()"></div>
    </div>
}

@code {
    [Parameter] public TValue? Value { get; set; }
    [Parameter] public EventCallback<TValue> ValueChanged { get; set; }
    [Parameter] public List<TOption> Options { get; set; } = new();
    [Parameter] public Func<TOption, string> LabelSelector { get; set; } = item => item?.ToString() ?? string.Empty;
    [Parameter] public Func<TOption, TValue> ValueSelector { get; set; } = item => (TValue)(object)item!;
    [Parameter] public Func<TOption, RenderFragment?>? IconSelector { get; set; }
    [Parameter] public Func<TOption, bool>? DisabledPredicate { get; set; }
    [Parameter] public SegmentedSize Size { get; set; } = SegmentedSize.Default;
    [Parameter] public bool Block { get; set; }
    [Parameter] public bool Disabled { get; set; }
    
    // Events
    [Parameter] public EventCallback<TValue> OnChange { get; set; }
    
    // Styling
    [Parameter] public string? CssClass { get; set; }
    [Parameter] public string? Style { get; set; }
    [Parameter] public bool IsRtl { get; set; }
    
    // RBAC
    [Parameter] public string? RequiredPermission { get; set; }
    [Parameter] public bool HideIfNoPermission { get; set; }
    
    // Audit
    [Parameter] public bool EnableAudit { get; set; }
    [Parameter] public string? AuditResource { get; set; }
    
    private bool _hasPermission = true;
    private int _selectedIndex = -1;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(RequiredPermission) && PermissionService != null)
        {
            _hasPermission = await PermissionService.HasPermissionAsync(RequiredPermission);
        }
        
        UpdateSelectedIndex();
    }

    protected override void OnParametersSet()
    {
        UpdateSelectedIndex();
    }

    private void UpdateSelectedIndex()
    {
        _selectedIndex = Options.FindIndex(o => EqualityComparer<TValue>.Default.Equals(ValueSelector(o), Value));
    }

    private async Task HandleSelectAsync(TOption option)
    {
        if (Disabled || (DisabledPredicate?.Invoke(option) ?? false)) return;
        
        var newValue = ValueSelector(option);
        Value = newValue;
        await ValueChanged.InvokeAsync(newValue);
        
        if (EnableAudit && AuditService != null)
        {
            await AuditService.LogAsync(new AuditMetadata
            {
                Action = "SegmentedChange",
                Resource = AuditResource ?? "Segmented",
                AdditionalData = new Dictionary<string, object>
                {
                    { "Value", newValue?.ToString() ?? string.Empty },
                    { "Label", LabelSelector(option) }
                }
            });
        }
        
        await OnChange.InvokeAsync(newValue);
        UpdateSelectedIndex();
    }

    private string GetSegmentedClass()
    {
        var classes = new List<string> 
        { 
            "n360-segmented",
            $"n360-segmented--{Size.ToString().ToLower()}"
        };
        
        if (Block)
        {
            classes.Add("n360-segmented--block");
        }
        
        if (Disabled)
        {
            classes.Add("n360-segmented--disabled");
        }
        
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        
        return string.Join(" ", classes);
    }

    private string GetIndicatorStyle()
    {
        if (_selectedIndex < 0 || _selectedIndex >= Options.Count) return "display: none;";
        
        var width = 100.0 / Options.Count;
        var left = _selectedIndex * width;
        
        return $"width: {width}%; left: {left}%; transition: all 0.3s;";
    }

    private Dictionary<string, object> GetHtmlAttributes()
    {
        var attributes = new Dictionary<string, object>();

        if (IsRtl)
        {
            attributes["dir"] = "rtl";
        }

        attributes["role"] = "radiogroup";

        return attributes;
    }
}
