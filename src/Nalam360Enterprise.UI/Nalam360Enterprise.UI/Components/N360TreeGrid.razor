@typeparam TItem
@using Nalam360Enterprise.UI.Models
@using Nalam360Enterprise.UI.Core.Security
@inject IPermissionService? PermissionService

<div class="n360-tree-grid @CssClass @(IsResponsive ? "responsive" : "") @(ShowBorders ? "bordered" : "")" 
     dir="@(IsRTL ? "rtl" : "ltr")"
     @attributes="GetHtmlAttributes()">

    @* Toolbar *@
    @if (ShowToolbar)
    {
        <div class="tree-grid-toolbar">
            <div class="toolbar-start">
                @if (AllowAdding && CanAdd)
                {
                    <button class="toolbar-btn" @onclick="AddRootNode" title="Add Root Node">
                        ‚ûï Add Root
                    </button>
                }
                @if (AllowExpanding)
                {
                    <button class="toolbar-btn" @onclick="ExpandAll" title="Expand All">
                        ‚¨áÔ∏è Expand All
                    </button>
                    <button class="toolbar-btn" @onclick="CollapseAll" title="Collapse All">
                        ‚¨ÜÔ∏è Collapse All
                    </button>
                }
                @if (AllowExport)
                {
                    <button class="toolbar-btn" @onclick="ExportData" title="Export">
                        üìä Export
                    </button>
                }
                @if (ShowRefreshButton)
                {
                    <button class="toolbar-btn" @onclick="RefreshData" title="Refresh">
                        üîÑ Refresh
                    </button>
                }
            </div>
            <div class="toolbar-end">
                @if (ShowSearch)
                {
                    <input type="search" 
                           class="toolbar-search" 
                           placeholder="Search..."
                           @bind="_searchQuery"
                           @bind:event="oninput"
                           @onkeyup="HandleSearch" />
                }
                @if (ShowStatistics)
                {
                    <div class="toolbar-stats">
                        <span class="stat-item">Total: @_statistics.TotalNodes</span>
                        <span class="stat-item">Selected: @_statistics.SelectedNodes</span>
                    </div>
                }
            </div>
        </div>
    }

    @* Grid Container *@
    <div class="tree-grid-container">
        <table class="tree-grid-table">
            <thead class="tree-grid-header">
                <tr>
                    @if (ShowCheckboxes)
                    {
                        <th class="checkbox-column">
                            <input type="checkbox" 
                                   @onchange="ToggleSelectAll"
                                   checked="@_allSelected" />
                        </th>
                    }
                    @foreach (var column in Columns.Where(c => c.Visible))
                    {
                        <th class="tree-grid-header-cell @(column.IsTreeColumn ? "tree-column" : "")"
                            style="width: @(column.Width)px; text-align: @column.TextAlign;">
                            <div class="header-content">
                                <span class="header-text">@column.HeaderText</span>
                                @if (column.AllowSorting && AllowSorting)
                                {
                                    <button class="sort-btn" @onclick="() => ToggleSort(column.Field)">
                                        @if (_sortDescriptor?.Field == column.Field)
                                        {
                                            <span>@(_sortDescriptor.Direction == TreeGridSortDirection.Ascending ? "‚¨ÜÔ∏è" : "‚¨áÔ∏è")</span>
                                        }
                                        else
                                        {
                                            <span class="sort-inactive">‚¨ç</span>
                                        }
                                    </button>
                                }
                                @if (column.AllowFiltering && AllowFiltering)
                                {
                                    <button class="filter-btn" @onclick="() => ShowFilterDialog(column.Field)" title="Filter">
                                        üîç
                                    </button>
                                }
                            </div>
                        </th>
                    }
                    @if (ShowActions)
                    {
                        <th class="actions-column">Actions</th>
                    }
                </tr>
            </thead>
            <tbody class="tree-grid-body">
                @if (_filteredNodes != null && _filteredNodes.Any())
                {
                    @foreach (var node in _filteredNodes)
                    {
                        @RenderNode(node)
                    }
                }
                else
                {
                    <tr>
                        <td colspan="@(_columnCount)" class="empty-state">
                            <div class="empty-content">
                                <span class="empty-icon">üìã</span>
                                <p class="empty-message">@EmptyText</p>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @* Paging *@
    @if (AllowPaging && _pageSettings != null)
    {
        <div class="tree-grid-pager">
            <div class="pager-info">
                Showing @((_pageSettings.CurrentPage - 1) * _pageSettings.PageSize + 1) 
                to @(Math.Min(_pageSettings.CurrentPage * _pageSettings.PageSize, _pageSettings.TotalRecords))
                of @_pageSettings.TotalRecords
            </div>
            <div class="pager-controls">
                <button class="pager-btn" 
                        @onclick="FirstPage" 
                        disabled="@(_pageSettings.CurrentPage == 1)">
                    ‚èÆÔ∏è
                </button>
                <button class="pager-btn" 
                        @onclick="PreviousPage" 
                        disabled="@(_pageSettings.CurrentPage == 1)">
                    ‚óÄÔ∏è
                </button>
                <span class="page-info">Page @_pageSettings.CurrentPage of @_pageSettings.TotalPages</span>
                <button class="pager-btn" 
                        @onclick="NextPage" 
                        disabled="@(_pageSettings.CurrentPage >= _pageSettings.TotalPages)">
                    ‚ñ∂Ô∏è
                </button>
                <button class="pager-btn" 
                        @onclick="LastPage" 
                        disabled="@(_pageSettings.CurrentPage >= _pageSettings.TotalPages)">
                    ‚è≠Ô∏è
                </button>
            </div>
            @if (_pageSettings.ShowPageSizeSelector)
            {
                <div class="page-size-selector">
                    <label>Page Size:</label>
                    <select @bind="_pageSettings.PageSize" @bind:after="OnPageSizeChanged">
                        @foreach (var size in _pageSettings.PageSizes)
                        {
                            <option value="@size">@size</option>
                        }
                    </select>
                </div>
            }
        </div>
    }

    @* Loading Overlay *@
    @if (IsLoading)
    {
        <div class="tree-grid-loading">
            <div class="loading-spinner"></div>
            <p>@LoadingText</p>
        </div>
    }

    @* Edit Dialog *@
    @if (_showEditDialog && _editingNode != null)
    {
        <div class="tree-grid-dialog-overlay" @onclick="CancelEdit">
            <div class="tree-grid-dialog" @onclick:stopPropagation="true">
                <div class="dialog-header">
                    <h3>@(_editMode == TreeGridRowAction.Add ? "Add New Item" : "Edit Item")</h3>
                    <button class="dialog-close" @onclick="CancelEdit">‚úñÔ∏è</button>
                </div>
                <div class="dialog-content">
                    @if (EditTemplate != null && _editingNode.Data != null)
                    {
                        @EditTemplate(_editingNode.Data)
                    }
                    else
                    {
                        @foreach (var column in Columns.Where(c => c.AllowEditing && c.Visible))
                        {
                            <div class="form-group">
                                <label>@column.HeaderText</label>
                                @if (column.EditTemplate != null)
                                {
                                    @((MarkupString)column.EditTemplate)
                                }
                                else
                                {
                                    <input type="text" 
                                           class="form-control" 
                                           value="@GetCellValue(_editingNode, column)" />
                                }
                            </div>
                        }
                    }
                </div>
                <div class="dialog-footer">
                    <button class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                    <button class="btn btn-primary" @onclick="SaveEdit">Save</button>
                </div>
            </div>
        </div>
    }

    @* Delete Confirmation Dialog *@
    @if (_showDeleteDialog && _deletingNode != null)
    {
        <div class="tree-grid-dialog-overlay" @onclick="CancelDelete">
            <div class="tree-grid-dialog delete-dialog" @onclick:stopPropagation="true">
                <div class="dialog-header">
                    <h3>Confirm Delete</h3>
                    <button class="dialog-close" @onclick="CancelDelete">‚úñÔ∏è</button>
                </div>
                <div class="dialog-content">
                    <p class="delete-warning">‚ö†Ô∏è Are you sure you want to delete this item?</p>
                    @if (_deletingNode.HasChildren)
                    {
                        <p class="delete-children-warning">
                            This item has @_deletingNode.Children.Count child item(s). 
                            They will also be deleted.
                        </p>
                    }
                </div>
                <div class="dialog-footer">
                    <button class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
                    <button class="btn btn-danger" @onclick="ConfirmDelete">Delete</button>
                </div>
            </div>
        </div>
    }

    @* Filter Dialog *@
    @if (_showFilterDialog)
    {
        <div class="tree-grid-dialog-overlay" @onclick="CloseFilterDialog">
            <div class="tree-grid-dialog filter-dialog" @onclick:stopPropagation="true">
                <div class="dialog-header">
                    <h3>Filter: @_filterField</h3>
                    <button class="dialog-close" @onclick="CloseFilterDialog">‚úñÔ∏è</button>
                </div>
                <div class="dialog-content">
                    <div class="form-group">
                        <label>Operator</label>
                        <select class="form-control" @bind="_filterOperator">
                            <option value="@TreeGridFilterOperator.Equal">Equals</option>
                            <option value="@TreeGridFilterOperator.NotEqual">Not Equals</option>
                            <option value="@TreeGridFilterOperator.Contains">Contains</option>
                            <option value="@TreeGridFilterOperator.StartsWith">Starts With</option>
                            <option value="@TreeGridFilterOperator.EndsWith">Ends With</option>
                            <option value="@TreeGridFilterOperator.GreaterThan">Greater Than</option>
                            <option value="@TreeGridFilterOperator.LessThan">Less Than</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Value</label>
                        <input type="text" 
                               class="form-control" 
                               @bind="_filterValue" 
                               placeholder="Enter filter value..." />
                    </div>
                </div>
                <div class="dialog-footer">
                    <button class="btn btn-secondary" @onclick="ClearFilter">Clear</button>
                    <button class="btn btn-primary" @onclick="ApplyFilter">Apply</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private RenderFragment<TreeGridNode<TItem>> RenderNode => (node) => __builder =>
    {
        var indent = node.Level * 20;
        var rowClass = $"tree-grid-row {(node.IsSelected ? "selected" : "")} level-{node.Level}";
        
        <tr class="@rowClass" data-node-id="@node.Id">
            @if (ShowCheckboxes)
            {
                <td class="checkbox-cell">
                    <input type="checkbox" 
                           @onchange="() => ToggleSelection(node)"
                           checked="@node.IsSelected" />
                </td>
            }
            @foreach (var column in Columns.Where(c => c.Visible))
            {
                <td class="tree-grid-cell @(column.IsTreeColumn ? "tree-cell" : "")"
                    style="text-align: @column.TextAlign;">
                    @if (column.IsTreeColumn)
                    {
                        <div class="tree-cell-content" style="padding-left: @(indent)px;">
                            @if (node.HasChildren)
                            {
                                <button class="expand-btn" @onclick="() => ToggleExpand(node)">
                                    @(node.IsExpanded ? "‚ñº" : "‚ñ∂")
                                </button>
                            }
                            else
                            {
                                <span class="leaf-spacer"></span>
                            }
                            @if (!string.IsNullOrEmpty(node.Icon))
                            {
                                <span class="node-icon">@node.Icon</span>
                            }
                            <span class="cell-value">@GetCellValue(node, column)</span>
                        </div>
                    }
                    else
                    {
                        <span class="cell-value">@GetCellValue(node, column)</span>
                    }
                </td>
            }
            @if (ShowActions)
            {
                <td class="actions-cell">
                    <div class="action-buttons">
                        @if (AllowAdding && node.AllowEdit && CanAdd)
                        {
                            <button class="action-btn add-child" 
                                    @onclick="() => AddChildNode(node)" 
                                    title="Add Child">
                                ‚ûï
                            </button>
                        }
                        @if (AllowEditing && node.AllowEdit && CanEdit)
                        {
                            <button class="action-btn edit" 
                                    @onclick="() => EditNode(node)" 
                                    title="Edit">
                                ‚úèÔ∏è
                            </button>
                        }
                        @if (AllowDeleting && node.AllowDelete && CanDelete)
                        {
                            <button class="action-btn delete" 
                                    @onclick="() => DeleteNode(node)" 
                                    title="Delete">
                                üóëÔ∏è
                            </button>
                        }
                    </div>
                </td>
            }
        </tr>
        @if (node.IsExpanded && node.HasChildren)
        {
            @foreach (var child in node.Children)
            {
                @RenderNode(child)
            }
        }
    };
}
