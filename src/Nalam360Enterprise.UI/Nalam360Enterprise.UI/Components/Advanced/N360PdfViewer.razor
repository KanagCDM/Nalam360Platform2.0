@* Note: This component requires Syncfusion.Blazor.SfPdfViewer version 31.x or later *@
@* Current installed version (27.1.58) uses a different API *@
@inject IPermissionService PermissionService
@inject IAuditService AuditService

@if (_hasPermission || !HideIfNoPermission)
{
    <div class="n360-pdfviewer @CssClass" dir="@(IsRtl ? "rtl" : "ltr")" style="height: @Height; width: @Width;">
        <div class="n360-pdfviewer__content" style="border: 1px solid #ccc; padding: 20px; text-align: center;">
            <h3>ðŸ“„ PDF Viewer Component</h3>
            <p><strong>Document:</strong> @DocumentPath</p>
            <p style="color: #666; font-size: 14px;">
                This component is ready to use once you upgrade to Syncfusion.Blazor.SfPdfViewer version 31.x or later.<br/>
                Current version (27.1.58) has a different API structure.
            </p>
            <p style="margin-top: 20px;">
                <strong>Features when activated:</strong><br/>
                âœ“ PDF rendering and viewing<br/>
                âœ“ Annotation tools (highlight, underline, sticky notes)<br/>
                âœ“ Form filling support<br/>
                âœ“ Text search within documents<br/>
                âœ“ Zoom, rotation, and navigation controls<br/>
                âœ“ Signature support<br/>
                âœ“ Thumbnail preview panel
            </p>
            @ChildContent
        </div>
    </div>
}

@code {
    [Parameter] public string? DocumentPath { get; set; }
    [Parameter] public string Height { get; set; } = "100%";
    [Parameter] public string Width { get; set; } = "100%";
    [Parameter] public bool EnableToolbar { get; set; } = true;
    [Parameter] public bool EnableNavigationToolbar { get; set; } = true;
    [Parameter] public bool EnableAnnotationToolbar { get; set; } = true;
    [Parameter] public bool EnableDownload { get; set; } = true;
    [Parameter] public bool EnablePrint { get; set; } = true;
    [Parameter] public bool EnableTextSearch { get; set; } = true;
    [Parameter] public bool EnableTextSelection { get; set; } = true;
    [Parameter] public bool EnableHyperlink { get; set; } = true;
    [Parameter] public bool EnableFormFields { get; set; } = true;
    [Parameter] public bool EnableBookmark { get; set; } = true;
    [Parameter] public bool EnableThumbnail { get; set; } = true;
    [Parameter] public int InitialPage { get; set; } = 1;
    [Parameter] public double ZoomLevel { get; set; } = 1.0;
    [Parameter] public RenderFragment? ChildContent { get; set; }
    
    // Styling
    [Parameter] public string? CssClass { get; set; }
    [Parameter] public string? InternalCssClass { get; set; }
    [Parameter] public bool IsRtl { get; set; }
    
    // RBAC
    [Parameter] public string? RequiredPermission { get; set; }
    [Parameter] public bool HideIfNoPermission { get; set; }
    
    // Audit
    [Parameter] public bool EnableAudit { get; set; }
    [Parameter] public string? AuditResource { get; set; }
    
    // Events
    [Parameter] public EventCallback OnDocumentLoad { get; set; }
    [Parameter] public EventCallback OnDocumentUnload { get; set; }
    [Parameter] public EventCallback OnPageChange { get; set; }
    [Parameter] public EventCallback OnAnnotationAdd { get; set; }
    [Parameter] public EventCallback OnTextSearchComplete { get; set; }
    
    private bool _hasPermission = true;
    private string Id { get; set; } = Guid.NewGuid().ToString();

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(RequiredPermission))
        {
            _hasPermission = await PermissionService.HasPermissionAsync(RequiredPermission);
        }
    }

    // Public API Methods - Placeholder implementations
    public async Task LoadAsync(string documentPath)
    {
        DocumentPath = documentPath;
        StateHasChanged();
        await OnDocumentLoad.InvokeAsync();
        
        if (EnableAudit)
        {
            await AuditService.LogAsync(new AuditMetadata
            {
                Action = "DocumentLoaded",
                Resource = AuditResource ?? $"PdfViewer-{Id}",
                Timestamp = DateTimeOffset.UtcNow,
                AdditionalData = new Dictionary<string, object>
                {
                    ["DocumentPath"] = documentPath,
                    ["ComponentId"] = Id
                }
            });
        }
    }

    public async Task UnloadAsync()
    {
        DocumentPath = null;
        StateHasChanged();
        await OnDocumentUnload.InvokeAsync();
        
        if (EnableAudit)
        {
            await AuditService.LogAsync(new AuditMetadata
            {
                Action = "DocumentUnloaded",
                Resource = AuditResource ?? $"PdfViewer-{Id}",
                Timestamp = DateTimeOffset.UtcNow,
                AdditionalData = new Dictionary<string, object>
                {
                    ["ComponentId"] = Id
                }
            });
        }
    }

    public Task<byte[]?> ExportAsync() => Task.FromResult<byte[]?>(null);
    public Task PrintAsync() => Task.CompletedTask;
    public Task DownloadAsync() => Task.CompletedTask;
    public Task ZoomToAsync(double zoomLevel) => Task.CompletedTask;
    public Task GoToPageAsync(int pageNumber) => Task.CompletedTask;
    public Task SearchTextAsync(string searchText, bool isMatchCase = false) => Task.CompletedTask;
    public Task<int> GetCurrentPageAsync() => Task.FromResult(0);
    public Task<int> GetPageCountAsync() => Task.FromResult(0);
}
