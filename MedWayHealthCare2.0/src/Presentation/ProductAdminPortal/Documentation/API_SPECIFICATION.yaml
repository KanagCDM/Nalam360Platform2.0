openapi: 3.0.3
info:
  title: ProductAdminPortal API
  description: |
    Domain-agnostic product configuration and subscription management system.
    
    ## Features
    - Multi-tenant product catalog management
    - Flexible pricing engine with tiered, per-unit, and complexity-based pricing
    - Usage tracking and billing calculation
    - Subscription lifecycle management
    - Audit trails and versioning
    - RBAC with granular permissions
    
    ## Authentication
    All endpoints require JWT bearer token authentication.
    
    ## Rate Limiting
    - 1000 requests per hour for authenticated users
    - 100 requests per hour for anonymous users
    
  version: 1.0.0
  contact:
    name: ProductAdminPortal Support
    email: support@productadminportal.com

servers:
  - url: https://api.productadminportal.com/v1
    description: Production server
  - url: https://staging-api.productadminportal.com/v1
    description: Staging server
  - url: http://localhost:5000/api/v1
    description: Local development

security:
  - bearerAuth: []

tags:
  - name: Authentication
    description: User authentication and authorization
  - name: Products
    description: Product catalog management
  - name: Modules
    description: Module management within products
  - name: Entities
    description: Entity (feature) management
  - name: Subscriptions
    description: Subscription plan configuration
  - name: Pricing
    description: Pricing rules and calculation
  - name: Customers
    description: Customer management
  - name: Usage
    description: Usage tracking and ingestion
  - name: Billing
    description: Invoice generation and billing
  - name: Simulation
    description: Pricing simulation and preview
  - name: Audit
    description: Audit logs and versioning
  - name: Import/Export
    description: Configuration import and export

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Error:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
      required:
        - code
        - message

    Product:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tenant_id:
          type: string
          format: uuid
        name:
          type: string
        key:
          type: string
        description:
          type: string
        metadata:
          type: object
        version:
          type: integer
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Module:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tenant_id:
          type: string
          format: uuid
        product_id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        display_order:
          type: integer
        metadata:
          type: object
        is_active:
          type: boolean

    Entity:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tenant_id:
          type: string
          format: uuid
        name:
          type: string
        entity_type:
          type: string
          enum: [resource, action, report, feature, integration]
        description:
          type: string
        pricing_enabled:
          type: boolean
        default_price:
          type: number
        pricing_unit:
          type: string
          enum: [per_transaction, per_user, per_month, per_year, per_gb, per_api_call, flat]
        complexity_levels:
          type: array
          items:
            type: string
        metadata:
          type: object

    SubscriptionPlan:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tenant_id:
          type: string
          format: uuid
        name:
          type: string
        key:
          type: string
        billing_cycle:
          type: string
          enum: [monthly, yearly, quarterly, one_time]
        base_fee:
          type: number
        currency_code:
          type: string
        trial_period_days:
          type: integer
        version:
          type: integer

    PricingRule:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tenant_id:
          type: string
          format: uuid
        name:
          type: string
        scope:
          type: string
          enum: [entity, module, subscription, global]
        target_id:
          type: string
          format: uuid
        pricing_type:
          type: string
          enum: [flat, per_unit, tiered, multiplier, percentage, bundle]
        params:
          type: object
        priority:
          type: integer
        effective_from:
          type: string
          format: date
        effective_to:
          type: string
          format: date

    UsageRecord:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tenant_id:
          type: string
          format: uuid
        customer_subscription_id:
          type: string
          format: uuid
        entity_id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        units:
          type: integer
        complexity:
          type: string
          enum: [low, medium, high, critical]
        metadata:
          type: object

    Invoice:
      type: object
      properties:
        id:
          type: string
          format: uuid
        invoice_number:
          type: string
        billing_period_start:
          type: string
          format: date
        billing_period_end:
          type: string
          format: date
        subtotal:
          type: number
        tax_amount:
          type: number
        discount_amount:
          type: number
        total_amount:
          type: number
        currency_code:
          type: string
        status:
          type: string
          enum: [draft, pending, paid, overdue, cancelled]
        line_items:
          type: array
          items:
            $ref: '#/components/schemas/InvoiceLineItem'

    InvoiceLineItem:
      type: object
      properties:
        description:
          type: string
        item_type:
          type: string
          enum: [base_fee, usage, one_time, discount, tax, adjustment]
        quantity:
          type: integer
        unit_price:
          type: number
        total_price:
          type: number

paths:
  # ===========================
  # AUTHENTICATION
  # ===========================
  /auth/login:
    post:
      tags:
        - Authentication
      summary: User login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                tenant_subdomain:
                  type: string
              required:
                - email
                - password
                - tenant_subdomain
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  expires_in:
                    type: integer
                  user:
                    type: object
        '401':
          description: Invalid credentials

  # ===========================
  # PRODUCTS
  # ===========================
  /products:
    get:
      tags:
        - Products
      summary: List all products
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: is_active
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: Products retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Product'
                  pagination:
                    type: object
                    properties:
                      page:
                        type: integer
                      limit:
                        type: integer
                      total:
                        type: integer

    post:
      tags:
        - Products
      summary: Create a new product
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                key:
                  type: string
                description:
                  type: string
                metadata:
                  type: object
              required:
                - name
                - key
            example:
              name: "Hospital Management System"
              key: "HMS_CORE"
              description: "Complete hospital management platform"
              metadata:
                industry: "healthcare"
      responses:
        '201':
          description: Product created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        '400':
          description: Validation error
        '409':
          description: Product key already exists

  /products/{productId}:
    get:
      tags:
        - Products
      summary: Get product by ID
      parameters:
        - name: productId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Product retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        '404':
          description: Product not found

    put:
      tags:
        - Products
      summary: Update product
      parameters:
        - name: productId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                metadata:
                  type: object
      responses:
        '200':
          description: Product updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'

    delete:
      tags:
        - Products
      summary: Delete product (soft delete)
      parameters:
        - name: productId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Product deleted successfully

  /products/{productId}/modules:
    get:
      tags:
        - Products
        - Modules
      summary: Get modules for a product
      parameters:
        - name: productId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Modules retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Module'

    post:
      tags:
        - Products
        - Modules
      summary: Add module to product
      parameters:
        - name: productId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                display_order:
                  type: integer
              required:
                - name
            example:
              name: "Patient Management"
              description: "Complete patient registration and records"
              display_order: 1
      responses:
        '201':
          description: Module added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Module'

  # ===========================
  # ENTITIES
  # ===========================
  /entities:
    get:
      tags:
        - Entities
      summary: List all entities
      parameters:
        - name: entity_type
          in: query
          schema:
            type: string
            enum: [resource, action, report, feature, integration]
        - name: pricing_enabled
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: Entities retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Entity'

    post:
      tags:
        - Entities
      summary: Create new entity
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                entity_type:
                  type: string
                  enum: [resource, action, report, feature, integration]
                description:
                  type: string
                pricing_enabled:
                  type: boolean
                default_price:
                  type: number
                pricing_unit:
                  type: string
                metadata:
                  type: object
              required:
                - name
                - entity_type
            example:
              name: "Patient Registration"
              entity_type: "action"
              description: "Register new patient"
              pricing_enabled: true
              default_price: 0.50
              pricing_unit: "per_transaction"
              metadata:
                complexity: ["low", "medium", "high"]
      responses:
        '201':
          description: Entity created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Entity'

  # ===========================
  # PRICING CALCULATION
  # ===========================
  /pricing/calculate:
    post:
      tags:
        - Pricing
      summary: Calculate pricing for usage
      description: |
        Calculate the invoice amount for a customer subscription based on usage records.
        This is the core pricing engine endpoint.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                tenant_id:
                  type: string
                  format: uuid
                customer_subscription_id:
                  type: string
                  format: uuid
                billing_period_start:
                  type: string
                  format: date
                billing_period_end:
                  type: string
                  format: date
                usage_records:
                  type: array
                  items:
                    type: object
                    properties:
                      entity_id:
                        type: string
                        format: uuid
                      units:
                        type: integer
                      complexity:
                        type: string
                        enum: [low, medium, high, critical]
                include_details:
                  type: boolean
                  default: true
              required:
                - tenant_id
                - customer_subscription_id
                - billing_period_start
                - billing_period_end
            example:
              tenant_id: "7c9e6679-7425-40de-944b-e07fc1f90ae7"
              customer_subscription_id: "550e8400-e29b-41d4-a716-446655440000"
              billing_period_start: "2025-11-01"
              billing_period_end: "2025-11-30"
              usage_records: [
                {
                  entity_id: "entity-001",
                  units: 8000,
                  complexity: "low"
                },
                {
                  entity_id: "entity-001",
                  units: 3000,
                  complexity: "medium"
                },
                {
                  entity_id: "entity-001",
                  units: 1500,
                  complexity: "high"
                }
              ]
              include_details: true
      responses:
        '200':
          description: Pricing calculated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  subscription_plan:
                    type: object
                    properties:
                      id:
                        type: string
                      name:
                        type: string
                      base_fee:
                        type: number
                  line_items:
                    type: array
                    items:
                      type: object
                      properties:
                        description:
                          type: string
                        entity_id:
                          type: string
                        quantity:
                          type: integer
                        unit_price:
                          type: number
                        total_price:
                          type: number
                        calculation_details:
                          type: object
                  subtotal:
                    type: number
                  tax_amount:
                    type: number
                  discount_amount:
                    type: number
                  total_amount:
                    type: number
                  currency_code:
                    type: string
              example:
                subscription_plan:
                  id: "plan-gold-001"
                  name: "Gold Plan"
                  base_fee: 1000.00
                line_items:
                  - description: "Gold Plan - Base Fee"
                    entity_id: null
                    quantity: 1
                    unit_price: 1000.00
                    total_price: 1000.00
                    calculation_details:
                      type: "base_fee"
                  - description: "Patient Registration - Low Complexity (Tier 1: 1001-10000)"
                    entity_id: "entity-001"
                    quantity: 7000
                    unit_price: 0.10
                    total_price: 700.00
                    calculation_details:
                      tier: "1001-10000"
                      complexity: "low"
                      multiplier: 1.0
                  - description: "Patient Registration - Medium Complexity (Tier 1: 1001-10000)"
                    entity_id: "entity-001"
                    quantity: 2000
                    unit_price: 0.20
                    total_price: 400.00
                    calculation_details:
                      tier: "1001-10000"
                      complexity: "medium"
                      multiplier: 2.0
                  - description: "Patient Registration - Medium Complexity (Tier 2: >10000)"
                    entity_id: "entity-001"
                    quantity: 1000
                    unit_price: 0.14
                    total_price: 140.00
                    calculation_details:
                      tier: ">10000"
                      complexity: "medium"
                      multiplier: 2.0
                  - description: "Patient Registration - High Complexity (Tier 2: >10000)"
                    entity_id: "entity-001"
                    quantity: 1500
                    unit_price: 0.28
                    total_price: 420.00
                    calculation_details:
                      tier: ">10000"
                      complexity: "high"
                      multiplier: 4.0
                subtotal: 2660.00
                tax_amount: 479.00
                discount_amount: 0.00
                total_amount: 3139.00
                currency_code: "INR"

  # ===========================
  # SIMULATION
  # ===========================
  /simulate:
    post:
      tags:
        - Simulation
      summary: Simulate pricing for projected usage
      description: |
        Simulate what an invoice would look like for a given subscription with projected usage.
        Useful for customers to preview costs before committing.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                subscription_plan_id:
                  type: string
                  format: uuid
                projected_usage:
                  type: array
                  items:
                    type: object
                    properties:
                      entity_id:
                        type: string
                        format: uuid
                      units:
                        type: integer
                      complexity_breakdown:
                        type: object
                        properties:
                          low:
                            type: integer
                          medium:
                            type: integer
                          high:
                            type: integer
                billing_cycle:
                  type: string
                  enum: [monthly, yearly]
                discount_code:
                  type: string
              required:
                - subscription_plan_id
                - projected_usage
            example:
              subscription_plan_id: "plan-gold-001"
              projected_usage:
                - entity_id: "entity-001"
                  units: 12500
                  complexity_breakdown:
                    low: 8000
                    medium: 3000
                    high: 1500
              billing_cycle: "monthly"
              discount_code: "LAUNCH20"
      responses:
        '200':
          description: Simulation completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  simulation_id:
                    type: string
                  subscription_plan:
                    type: object
                  projected_invoice:
                    $ref: '#/components/schemas/Invoice'
                  savings_vs_other_plans:
                    type: array
                    items:
                      type: object

  # ===========================
  # VERSIONING & AUDIT
  # ===========================
  /configuration/versions:
    get:
      tags:
        - Audit
      summary: List configuration versions
      responses:
        '200':
          description: Versions retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    version_number:
                      type: integer
                    version_name:
                      type: string
                    created_at:
                      type: string
                      format: date-time
                    created_by:
                      type: string

    post:
      tags:
        - Audit
      summary: Create configuration snapshot
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                version_name:
                  type: string
                description:
                  type: string
      responses:
        '201':
          description: Snapshot created

  /configuration/versions/{versionNumber}:
    get:
      tags:
        - Audit
      summary: Get specific configuration version
      parameters:
        - name: versionNumber
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Version retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  version_number:
                    type: integer
                  snapshot:
                    type: object

  /audit-logs:
    get:
      tags:
        - Audit
      summary: Get audit logs
      parameters:
        - name: entity_type
          in: query
          schema:
            type: string
        - name: entity_id
          in: query
          schema:
            type: string
        - name: user_id
          in: query
          schema:
            type: string
        - name: from_date
          in: query
          schema:
            type: string
            format: date
        - name: to_date
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Audit logs retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  # ===========================
  # IMPORT/EXPORT
  # ===========================
  /export/configuration:
    get:
      tags:
        - Import/Export
      summary: Export complete configuration
      parameters:
        - name: format
          in: query
          schema:
            type: string
            enum: [json, csv]
            default: json
        - name: include
          in: query
          schema:
            type: array
            items:
              type: string
              enum: [products, modules, entities, subscriptions, pricing_rules]
      responses:
        '200':
          description: Configuration exported
          content:
            application/json:
              schema:
                type: object
            text/csv:
              schema:
                type: string

  /import/configuration:
    post:
      tags:
        - Import/Export
      summary: Import configuration
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                mode:
                  type: string
                  enum: [merge, replace]
                  default: merge
      responses:
        '200':
          description: Import successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  imported_count:
                    type: integer
                  errors:
                    type: array
                    items:
                      type: object
