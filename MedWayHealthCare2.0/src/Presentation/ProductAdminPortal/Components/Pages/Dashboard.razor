@page "/dashboard"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthService AuthService
@inject ModuleService ModuleService
@inject NavigationManager Navigation

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>üéØ Welcome, @username!</h1>
        <p>Your Admin Dashboard</p>
    </div>

    <div class="modules-overview">
        <h2>Your Active Modules</h2>
        <div class="module-cards">
            @foreach (var module in activeModules)
            {
                <div class="dashboard-module-card" style="border-left: 4px solid @module.Color">
                    <div class="module-header">
                        <span class="module-icon" style="background-color: @module.Color">@module.Icon</span>
                        <h3>@module.Name</h3>
                    </div>
                    <p class="module-desc">@module.Description</p>
                    <a href="/@module.Id" class="module-link">Open Module ‚Üí</a>
                </div>
            }
        </div>
    </div>

    <div class="quick-stats">
        <h2>Quick Statistics</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-value">1,247</div>
                <div class="stat-label">Total Patients</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-value">38</div>
                <div class="stat-label">Today's Appointments</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-value">$12,450</div>
                <div class="stat-label">Today's Revenue</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üì¶</div>
                <div class="stat-value">156</div>
                <div class="stat-label">Low Stock Items</div>
            </div>
        </div>
    </div>

    <div class="recent-activity">
        <h2>Recent Activity</h2>
        <div class="activity-list">
            <div class="activity-item">
                <span class="activity-icon">üë§</span>
                <div class="activity-content">
                    <p><strong>New patient registered:</strong> John Doe</p>
                    <small>5 minutes ago</small>
                </div>
            </div>
            <div class="activity-item">
                <span class="activity-icon">üìÖ</span>
                <div class="activity-content">
                    <p><strong>Appointment scheduled:</strong> Dr. Smith - 2:30 PM</p>
                    <small>12 minutes ago</small>
                </div>
            </div>
            <div class="activity-item">
                <span class="activity-icon">üí∞</span>
                <div class="activity-content">
                    <p><strong>Payment received:</strong> Invoice #1234 - $450</p>
                    <small>28 minutes ago</small>
                </div>
            </div>
            <div class="activity-item">
                <span class="activity-icon">‚ö†Ô∏è</span>
                <div class="activity-content">
                    <p><strong>Low stock alert:</strong> Surgical gloves - 5 units remaining</p>
                    <small>1 hour ago</small>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .dashboard-container {
        padding: 30px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .dashboard-header {
        margin-bottom: 40px;
        padding: 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        color: white;
        text-align: center;
    }

    .dashboard-header h1 {
        margin: 0 0 10px 0;
        font-size: 2.5rem;
        font-weight: 700;
    }

    .dashboard-header p {
        margin: 0;
        opacity: 0.9;
        font-size: 1.2rem;
    }

    .modules-overview, .quick-stats, .recent-activity {
        margin-bottom: 40px;
    }

    .modules-overview h2, .quick-stats h2, .recent-activity h2 {
        margin-bottom: 20px;
        color: #333;
        font-size: 1.8rem;
        font-weight: 600;
    }

    .module-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }

    .dashboard-module-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s;
    }

    .dashboard-module-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }

    .module-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
    }

    .module-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }

    .module-header h3 {
        margin: 0;
        font-size: 1.3rem;
        color: #333;
        font-weight: 600;
    }

    .module-desc {
        color: #666;
        margin: 0 0 16px 0;
        line-height: 1.5;
    }

    .module-link {
        display: inline-flex;
        align-items: center;
        color: #667eea;
        text-decoration: none;
        font-weight: 600;
        transition: transform 0.2s;
    }

    .module-link:hover {
        transform: translateX(4px);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
    }

    .stat-icon {
        font-size: 3rem;
        margin-bottom: 12px;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 8px;
    }

    .stat-label {
        color: #666;
        font-size: 0.95rem;
    }

    .activity-list {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .activity-item {
        display: flex;
        align-items: start;
        gap: 16px;
        padding: 16px;
        border-bottom: 1px solid #f0f0f0;
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        font-size: 24px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f5f5f5;
        border-radius: 8px;
        flex-shrink: 0;
    }

    .activity-content p {
        margin: 0 0 4px 0;
        color: #333;
    }

    .activity-content small {
        color: #999;
    }
</style>

@code {
    private string username = "";
    private List<Module> activeModules = new();

    protected override async Task OnInitializedAsync()
    {
        // Check authentication
        var isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (!isAuthenticated)
        {
            Navigation.NavigateTo("/login", forceLoad: false);
            return;
        }

        username = await AuthService.GetCurrentUserAsync() ?? "User";
        var selectedModuleIds = await AuthService.GetSelectedModulesAsync();
        
        activeModules = new List<Module>();
        foreach (var moduleId in selectedModuleIds)
        {
            var module = await ModuleService.GetModuleByIdAsync(moduleId);
            if (module != null)
            {
                activeModules.Add(module);
            }
        }
    }
}
